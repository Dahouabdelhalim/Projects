################################################################################
# From Balisi and Van Valkenburgh (2020) Communications Biology
# CODE FOR FIGURE 3:
## Species richness and extinction rates for North American fossil canids, 
## both large hypercarnivores and not
################################################################################


## set up large multipanel plot
library(scales)
library(viridis)
trans = 0.25

## log files and long lists of numbers below generated by PyRate analyses
# 95% HPDs calculated using code from Biopy (https://www.cs.auckland.ac.nz/~yhel002/biopy/)


################################################################################
# FIGURE 3
################################################################################

par(mfrow=c(2, 1), mar=c(0, 5, 0, 0)+0.1, oma=c(4.5, 0, 0, 0), cex.lab=2, cex.axis=1.5)


################################################################################
# Figure 3A. Species richness
################################################################################

# read in not-large hypercarnivore data
tbl_notLg = read.table(file="pyrate_mcmc_logs/notLgHyper_lineageThroughTime.txt", header=T)
time_notLg = -tbl_notLg$time

# read in large-hypercarnivore data
tbl_lgH = read.table(file="pyrate_mcmc_logs/lgHyper_lineageThroughTime.txt", header=T)
time_lgH = -tbl_lgH$time

# set up plot with notLg dimensions because notLg more expansive
plot(time_notLg, tbl_notLg$diversity, type="n", ylab= "Number of species",
     xlab="Time (Ma)", xlim=c(-40, 0), ylim=c(0, 30), xaxt="n")
# credible interval for not-large hypercarnivores:
polygon(c(time_notLg, rev(time_notLg)), c(tbl_notLg$M_div, rev(tbl_notLg$m_div)),
        col=alpha(viridis(4)[2], trans), border=NA)
# credible interval for large hypercarnivores:
polygon(c(time_lgH, rev(time_lgH)), c(tbl_lgH$M_div, rev(tbl_lgH$m_div)), 
        col=alpha(viridis(4)[4], trans), border=NA)
# average line for not-large hypercarnivores:
lines(time_notLg, tbl_notLg$diversity, type="l", lwd=3, col=viridis(4)[2])
# average line for large hypercarnivores:
lines(time_lgH, tbl_lgH$diversity, type="l", lwd=3, col=viridis(4)[4])


################################################################################
# Figure 3B. Extinction rates
################################################################################

# notLg times--also for extinction rates later
time_div_notLg = c(-0.500252842105, -1.50075852632, -2.50126421053, -3.50176989474,
                   -4.50227557895, -5.50278126316, -6.50328694737, -7.50379263158,
                   -8.50429831579, -9.504804, -10.5053096842, -11.5058153684,
                   -12.5063210526, -13.5068267368, -14.5073324211, -15.5078381053,
                   -16.5083437895, -17.5088494737, -18.5093551579, -19.5098608421,
                   -20.5103665263, -21.5108722105, -22.5113778947, -23.5118835789,
                   -24.5123892632, -25.5128949474, -26.5134006316, -27.5139063158,
                   -28.514412, -29.5149176842, -30.5154233684, -31.5159290526,
                   -32.5164347368, -33.5169404211, -34.5174461053, -35.5179517895,
                   -36.5184574737, -37.5189631579)
# lgHyper times--also for extinction rates later
time_div_lgH = c(-0.515298892857, -1.54589667857, -2.57649446429, -3.60709225,
                 -4.63769003571, -5.66828782143, -6.69888560714, -7.72948339286,
                 -8.76008117857, -9.79067896429, -10.82127675, -11.8518745357,
                 -12.8824723214, -13.9130701071, -14.9436678929, -15.9742656786,
                 -17.0048634643, -18.03546125, -19.0660590357, -20.0966568214,
                 -21.1272546071, -22.1578523929, -23.1884501786, -24.2190479643,
                 -25.24964575, -26.2802435357, -27.3108413214, -28.3414391071)

# notLg extinction rates
rate_ex_notLg = c(0.506162853863, 0.506162330404, 0.504951842325, 0.501630397942,
                  0.499258733773, 0.493366025957, 0.487897839908, 0.486520596396,
                  0.485519459278, 0.485164807836, 0.484494442885, 0.483961434901,
                  0.483770924626, 0.481406885882, 0.479287966122, 0.479005387106,
                  0.479417727326, 0.482303628405, 0.476923516423, 0.454080089956,
                  0.142102427113, 0.136923935386, 0.136808966729, 0.137396699778,
                  0.137918262916, 0.138207547985, 0.138461774707, 0.13865700271,
                  0.138267350558, 0.135602030681, 0.134668689565, 0.134389687061,
                  0.134272119483, 0.134259326174, 0.134157206787, 0.134059733611,
                  0.134023480127, 0.134032416543)
minHPD_ex_notLg = c(0.321654084389, 0.321654084389, 0.324029877092, 0.320859878429,
                    0.319905674732, 0.31663531098, 0.330943849733, 0.33457326281,
                    0.336369713846, 0.337031168723, 0.337678151005, 0.338368674689,
                    0.336701681783, 0.332713207368, 0.328504581232, 0.327549600965,
                    0.328101788976, 0.321205619495, 0.146442826477, 0.104120378396,
                    0.0725358772269, 0.0676038679255, 0.0749260354739, 0.0786296732191,
                    0.0811044066496, 0.0818575650187, 0.0811630527487, 0.0807747106522,
                    0.080322103039, 0.0687542822945, 0.0564278684939, 0.0509952352228,
                    0.0477932299587, 0.0471064884405, 0.0415183735081, 0.0382131491382,
                    0.0363344678488, 0.0310161268574)
maxHPD_ex_notLg = c(1.0635228137, 1.0635228137, 1.03970063549, 0.975752083735,
                    0.928297215724, 0.77445633317, 0.679863453881, 0.666839243216,
                    0.659778404989, 0.656669727786, 0.653058885123, 0.651197213483,
                    0.648882804257, 0.64579151426, 0.645758938712, 0.645758938712,
                    0.648178995467, 0.659380777753, 0.631853356725, 0.606485902393,
                    0.499292130725, 0.226991996741, 0.2168069619, 0.211380731587,
                    0.209665698568, 0.209956809488, 0.210393705031, 0.212205754724,
                    0.212667474231, 0.214552268166, 0.212669150344, 0.21011559537,
                    0.208576442557, 0.209948492183, 0.20762458169, 0.207262750234,
                    0.208581545717, 0.207035483075)

# lgHyper extinction rates
rate_ex_lgH = c(0.585691472435, 0.580123528764, 0.462776195294, 0.425525935846,
                0.41382401026, 0.351884005432, 0.321147508808, 0.293580194952,
                0.278644976743, 0.273542227028, 0.267702195489, 0.265559491561,
                0.265190107276, 0.264562050749, 0.264285886105, 0.264056997617,
                0.263723476319, 0.263451144426, 0.262802864669, 0.261873341589,
                0.26032522227, 0.258646313057, 0.257176227913, 0.255760731757,
                0.253797833309, 0.252557800438, 0.251970923092, 0.251857566889)
minHPD_ex_lgH = c(0.187964643595, 0.189007665916, 0.172926896611, 0.170911584979,
                  0.171107821241, 0.147568327446, 0.138383583791, 0.124740324097,
                  0.12093920139, 0.124866725477, 0.128877015058, 0.13006465591,
                  0.130465355346, 0.128942460346, 0.129467845883, 0.128578701573,
                  0.128231625831, 0.125713641531, 0.125757785565, 0.122371001571,
                  0.119281396712, 0.114863757667, 0.110774581312, 0.104659841183,
                  0.0990277985833, 0.0925562202044, 0.0886892352894, 0.0820366129803)
maxHPD_ex_lgH = c(1.54895154339, 1.52927926042, 1.19653845016, 1.13237493412,
                  1.12520024397, 0.939145641596, 0.807048394877, 0.640966130222,
                  0.498357329095, 0.457456658549, 0.426118390438, 0.418322143419,
                  0.416916196204, 0.414587367516, 0.415355102716, 0.415338015163,
                  0.416495358637, 0.41654839457, 0.419043196662, 0.419083108506,
                  0.42066322241, 0.421257171745, 0.420937256298, 0.419038945349,
                  0.420963501598, 0.420846090917, 0.422543512577, 0.423369083384)

# plot all
plot(time_div_notLg, time_div_notLg, type="n", xlim=c(-40, 0),
     ylim=c(0, 1.54895154339), ylab="Extinction rate", xlab="Time", main="")
# credible interval for not-large hypercarnivores:
polygon(c(time_div_notLg, rev(time_div_notLg)), c(maxHPD_ex_notLg, rev(minHPD_ex_notLg)), 
        col=alpha(viridis(4)[2],trans), border = NA)
# credible interval for large hypercarnivores:
polygon(c(time_div_lgH, rev(time_div_lgH)), c(maxHPD_ex_lgH, rev(minHPD_ex_lgH)), 
        col=alpha(viridis(4)[4], trans), border=NA)
# average for not-large hypercarnivores:
lines(time_div_notLg, rate_ex_notLg, col=viridis(4)[2], lwd=3)
# average for large hypercarnivores:
lines(time_div_lgH, rate_ex_lgH, col=viridis(4)[4], lwd=3)


################################################################################
# LEGEND
################################################################################

legend(-40, 1.5, c("large hypercarnivores", "all other canids"), lwd=3, 
       x.intersp=0.25, col=viridis(4)[c(4, 2)], bty="n", cex=2, y.intersp=0.5)

mtext(text="Time (millions of years)", side=1, line=3, outer=TRUE, cex=2)