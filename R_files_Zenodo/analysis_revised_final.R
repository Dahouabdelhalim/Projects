#analyze. R

#LAST UPDATED 9/5/2021

#This script uses rq.final.csv, which contains processed respirometry and body 
#composition data for each minute (generated by FAT_FINAL_PROCESSING.r) 
#This script labels/cleans out some bad runs, and corrects some variables, and then 
#aggregates this dataset into the run.agg dataframe. The script then continues to correct some variables
#and then is used as a reference to create the prop dataframe (torpor propensity). 
#This script also uses food.data.csv which contains processed food consumption data (generated by FOOD_DATA.R)
#This script also uses the period.cutoffs dataset (generated by the script BODY_MASS_FINAL.R.)
#These dataframes are updated in this script before analyses, and updated datasets are saved
#for use in the plot.R script. 

#All these dataframes are then used to generate several statistical models to 
#evaluate the relationships between variables of interest. 
#The script also generates exploratory plots of these relationships and generates analyses and descriptive stats. 

################################################################################
################################################################################

#set working directory
setwd("~/ERICH_EBERTS/ACADEMICS/PROJECTS/FAT/FAT_DATA/FAT_CODE/FINAL_DATA")

################################################################################

#load in libraries
library(readxl)
library(ggplot2)
library(ggpubr)
library(tidyr)
library(dplyr)
library(plotrix)
library(gridExtra)
library(changepoint)
library(changepoint.np)
library(MESS)
library(nlme) 
library(effects)
library(lme4)
library(lmerTest)
library(rmcorr)
library(sjstats)
library(sjPlot)
library(car)
library(emmeans)
library(MuMIn)
library(influence.ME)

################################################################################

#set my theme for any ggplot graphs i output.
my_theme <- theme_classic(base_size = 20) +
  theme(panel.border = element_rect(colour = "black", fill=NA)) +
  theme(axis.text.x = element_text(angle=0, size=16), legend.key.height = unit(3, 'lines'),
        panel.grid.major.y = element_line(color='white'),
        panel.grid.minor.y = element_line(color='white'))+
  theme(axis.text.y = element_text(angle=0, size=20), legend.key.height = unit(3, 'lines'),
        panel.grid.major.x = element_line(color='white'), 
        panel.grid.minor.x = element_line(color='white'))+
  theme(plot.caption = element_text(size = 20, hjust = 0.5))#+theme(legend.position="none")
#theme(legend.title=element_text("FreeSerif"))

################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################

#LOAD AND FIX DATA

################################################################################

#RESPIROMETRY/BODY COMP DATA

all.data.1min<-read.csv("rq_final.csv") 

################################################################################
#CORRECT AND CALCULATE A BUNCH OF VARIABLES IN ALL.DATA.1MIN

################################################################################

#correct structure of photoperiod
all.data.1min$Photoperiod<-factor(all.data.1min$Photoperiod, levels=c("1","2","3","4","5","6","7","8","9","10"))

#correct temperature structure to character
all.data.1min$Temperature<-as.character(as.numeric(all.data.1min$Temperature))
#unique(all.data.1min$Temperature)#will take out 10 and 30 c runs below.

#correct instantaneous fat % #DONT RUN THIS TWICE!!!!!!!!!!!!!!!!!!!!!!!!
all.data.1min$Fat_p<-all.data.1min$Fat_p*100

################################################################################
################################################################################

#CALCULATE A BUNCH OF NEW VARIABLES (mostly converting stuff)

#calculate evening fat content as a % body mass
all.data.1min$Fat_Eve_p<-(all.data.1min$Fat_Eve_g/all.data.1min$Body_Eve_g) *100

#calculate morning fat content as a % body mass
all.data.1min$Fat_Morn_p<-(all.data.1min$Fat_Morn_g/all.data.1min$Body_Morn_g)*100

#calculate amount of fat (mass) expended the whole night
all.data.1min$Expend_Total_g<-all.data.1min$Expend_Total_kJ/37

#calculate amount of energy / fat expended before torpor #note this will only work for torpor nights (normos will be na)
all.data.1min$Fat_Loss_pretorpor<-all.data.1min$Expend_Fat_pre_g

#rename fat entry p as crit fat p (no real reason to do this)
all.data.1min$Crit_Fat_p<-all.data.1min$Fat_Entry_p
#crit_fat- this can be either the fat threshold value on torpor nights, or the morning fat value on normothermic nights. 

#create a crit_time_p variable for the time of torpor entry or morning on normothermic nights
all.data.1min$Crit_Time_p[all.data.1min$Torpor_Use=="TORPOR"]<- all.data.1min$Time_p_Entry_Start[all.data.1min$Torpor_Use=="TORPOR"]
all.data.1min$Crit_Time_p[all.data.1min$Torpor_Use=="NORMO"]<- 100

################################################################################
################################################################################

#SUBSET OUT SOME DATA THAT I DONT WANT TO INCLUDE FOR WHATEVER REASON

################################################################################

#First label everything as good. 
all.data.1min$Run_Quality<-"GOOD"

################################################################################

all.data.1min<-all.data.1min[all.data.1min$Temperature=="20",]

################################################################################

#subset out only birds 1-16 (birds that are all adults (except for 5) and i have fairly consitent data for.
bird_ids<-c("B1","B2","B3","B4","B5", "B6","B7","B8","B9","B10", "B11","B12","B13","B14","B15", "B16")
all.data.1min<-all.data.1min[all.data.1min$Bird_ID %in% bird_ids ,]
#convert bird id to a factor
all.data.1min$Bird_ID<-factor(all.data.1min$Bird_ID,levels=c("B1","B2","B3","B4","B5","B6","B7","B8","B9","B10","B11","B12","B13","B14","B15","B16"))

##############################################################################

#THESE RUNS ARE EITHER LEAKY OR THE TEMP WAS NOT CONSISTENT SO THEY ARE UNRELIABLE DATA. 
all.data.1min$Run_Quality[all.data.1min$Run_ID=="B1_8.27.18"]<-"BAD"
all.data.1min$Run_Quality[all.data.1min$Run_ID=="B5_8.27.18"]<-"BAD"
all.data.1min$Run_Quality[all.data.1min$Run_ID=="B4_9.8.18"]<-"BAD"
all.data.1min$Run_Quality[all.data.1min$Run_ID=="B5_9.8.18"]<-"BAD"
all.data.1min$Run_Quality[all.data.1min$Run_ID=="B4_9.25.18"]<-"BAD"
all.data.1min$Run_Quality[all.data.1min$Run_ID=="B5_9.25.18"]<-"BAD"
all.data.1min$Run_Quality[all.data.1min$Run_ID=="B12_7.7.19"]<-"BAD" #LEAK I THINK 
all.data.1min$Run_Quality[all.data.1min$Run_ID=="B7_7.16.19"]<-"BAD"
all.data.1min$Run_Quality[all.data.1min$Run_ID=="B11_9.17.19"]<-"BAD"
#take out these nights
all.data.1min<-all.data.1min[all.data.1min$Run_Quality!="BAD",]

##############################################################################

#THESE RUNS ARE BAD BECAUSE THEY ARE DOUBLE TORPOR AND THATS JUST WEIRD LOL (BUT REALLY THE STATE LABEL FUNCTION DONT WORK FOR THEM AND ITS JUST 4 NIGHTS)
all.data.1min$Run_Quality[all.data.1min$Run_ID=="B5_9.2.18"]<-"DOUBLE"
all.data.1min$Run_Quality[all.data.1min$Run_ID=="B5_9.8.18"]<-"DOUBLE"#REPEAT
all.data.1min$Run_Quality[all.data.1min$Run_ID=="B15_7.2.19"]<-"DOUBLE"
all.data.1min$Run_Quality[all.data.1min$Run_ID=="B16_7.7.19"]<-"DOUBLE"
#take out these doubles
all.data.1min<-all.data.1min[all.data.1min$Run_Quality!="DOUBLE",]

##############################################################################

#DONT take out dips
#dips are NOT good for depth (they are good for duratoin and time of entry, and threhsold but not depth)
all.data.1min$Run_Quality[all.data.1min$Run_ID=="B2_8.6.18"]<-"DIP"
all.data.1min$Run_Quality[all.data.1min$Run_ID=="B3_9.23.18"]<-"DIP"
all.data.1min$Run_Quality[all.data.1min$Run_ID=="B9_6.25.19"]<-"DIP"
all.data.1min$Run_Quality[all.data.1min$Run_ID=="B7_7.10.19"]<-"DIP"
all.data.1min$Run_Quality[all.data.1min$Run_ID=="B9_8.26.19"]<-"DIP"
all.data.1min$Run_Quality[all.data.1min$Run_ID=="B13_9.1.19"]<-"DIP"
all.data.1min$Run_Quality[all.data.1min$Run_ID=="B14_9.6.19"]<-"DIP"
all.data.1min$Run_Quality[all.data.1min$Run_ID=="B8_9.10.19"]<-"DIP"

##############################################################################
##############################################################################

#write an updated csv file to use for plotting
#this is normally turned off when testing and writing this code.
#write.csv(all.data.1min, "all_data_1min.csv")

###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################
###############################################################################

#GENERATE RUN.AGG, WHICH HAS ONE LINE FOR EACH RUN... use all.data.1min to generate this dataframe. 

run.agg<-all.data.1min %>%
  #group by run-specific variables that have one value per run. 
  group_by(Run_ID, Date_Index, Year, Bird_ID,  Season,  Run_Quality,
            Temperature, Photoperiod, Night_Duration,
            Body_Eve_g, Body_Morn_g, 
            Fat_Eve_p, Fat_Morn_p,
            Fat_Eve_g, Fat_Morn_g,
            Lean_Eve_g,Lean_Morn_g,
            VO2_Torpor_mean,
            Expend_Total_g,Expend_Total_kJ,
            Torpor_Use, Torpor_Type,
            Time_p_Entry_Start, Fat_Entry_p, Crit_Fat_p, Crit_Time_p,
            Fat_Loss_pretorpor_kJ,
            Entry_Duration, Torpor_Duration, Arousal_Duration, Met_Dep_p) %>%
  #summarize (usually mean +- std error) variables that have multiple values per run (i.e. minute data)
  summarize(VO2_mean = mean(VO2, na.rm = T),
            VO2_std.error = std.error(VO2, na.rm = T),
            VCO2_mean = mean(VCO2, na.rm = T),
            VCO2_std.error = std.error(VCO2, na.rm = T),
            RER_mean = mean(RER, na.rm = T),
            RER_std.error = std.error(RER, na.rm = T),
            WVP_kPa_mean = mean(WVP_kPa, na.rm = T),
            WVP_kPa_std.error = std.error(WVP_kPa, na.rm = T))%>%
          data.frame()

################################################################################
################################################################################

#CORRECT A BUNCH OF VARIABLES

#correct the str of torpor use
run.agg$Torpor_Use<-factor(run.agg$Torpor_Use, levels=c("NORMO", "TORPOR"))#run.agg$Torpor_Duration[run.agg$Torpor_Use=="NORMO"]<-0

#fix str of temperature and subset only 20 c trials. 
run.agg$Temperature<-as.character(as.numeric(run.agg$Temperature))
run.agg<-run.agg[run.agg$Temperature=="20",] #ONLY LOOK AT 20C!!!!

#correct the str of season
run.agg$Season<-factor(run.agg$Season, levels=c("Summer", "Fattening", "Migration","Non-Fattener"),ordered = F)

#rename total nightly energy expenditure
run.agg$Nightly_Expend<-run.agg$Expend_Total_kJ

#create torpor bin variable for logistic regression
unique(run.agg$Torpor_Use)
run.agg$Torpor_Use_bin[run.agg$Torpor_Use=="TORPOR"]<-1
run.agg$Torpor_Use_bin[run.agg$Torpor_Use=="NORMO"]<-0

#create torpor duration_ET variable for full duraiton time
run.agg$Torpor_Duration_ET<-run.agg$Entry_Duration+run.agg$Torpor_Duration 
run.agg$Torpor_Duration_ET_h<-run.agg$Torpor_Duration_ET/60

#label all normothermic nights as having 0 minuttes/hrs of torpor duration
run.agg$Torpor_Duration_ET[run.agg$Torpor_Use=="NORMO"]<-0
run.agg$Torpor_Duration_ET_h[run.agg$Torpor_Use=="NORMO"]<-0

#label the torpor type of all normothermic nights as normo
run.agg$Torpor_Type[run.agg$Torpor_Use=="NORMO"]<-"NORMO"

#calculate amount of mass content lost overnight # though i dont actually use this i dont htink 
run.agg$Body_delta_g<-run.agg$Body_Eve_g-run.agg$Body_Morn_g
run.agg$Body_delta_g[run.agg$Body_delta_g<.015]<-NA

#calculate amount of fat content lost overnight
run.agg$Nightly_Expend_g<-run.agg$Nightly_Expend/37.7
run.agg$Fat_delta_g<-run.agg$Nightly_Expend_g

#convert fat mass loss to micrograms. 
run.agg$Fat_delta_mg<-run.agg$Fat_delta_g*100

################################################################################

#Turn a few wonky bad qmr scan points to NA
run.agg$Lean_Quality<-"GOOD"
run.agg$Lean_Quality[run.agg$Lean_Morn_g<2 & run.agg$Season=="Fattening"]<-"BAD"
run.agg$Lean_Morn_g[run.agg$Lean_Quality=="BAD"]<-NA

################################################################################
################################################################################

# 
# b1<-as.numeric(max(run.agg$Date_Index[run.agg$Season=="Summer"&run.agg$Bird_ID=="B1"], na.rm=T))
# b2<-as.numeric(max(run.agg$Date_Index[run.agg$Season=="Summer"&run.agg$Bird_ID=="B2"], na.rm=T))
# b3<-as.numeric(max(run.agg$Date_Index[run.agg$Season=="Summer"&run.agg$Bird_ID=="B3"], na.rm=T))
# b4<-as.numeric(max(run.agg$Date_Index[run.agg$Season=="Summer"&run.agg$Bird_ID=="B4"], na.rm=T))
# b5<-as.numeric(max(run.agg$Date_Index[run.agg$Season=="Summer"&run.agg$Bird_ID=="B5"], na.rm=T))
# b6<-as.numeric(max(run.agg$Date_Index[run.agg$Season=="Summer"&run.agg$Bird_ID=="B6"], na.rm=T))
# b7<-as.numeric(max(run.agg$Date_Index[run.agg$Season=="Summer"&run.agg$Bird_ID=="B7"], na.rm=T))
# b8<-as.numeric(max(run.agg$Date_Index[run.agg$Season=="Summer"&run.agg$Bird_ID=="B8"], na.rm=T))
# b9<-as.numeric(max(run.agg$Date_Index[run.agg$Season=="Summer"&run.agg$Bird_ID=="B9"], na.rm=T))
# b10<-as.numeric(max(run.agg$Date_Index[run.agg$Season=="Summer"&run.agg$Bird_ID=="B10"], na.rm=T))
# b11<-as.numeric(max(run.agg$Date_Index[run.agg$Season=="Summer"&run.agg$Bird_ID=="B11"], na.rm=T))
# b12<-as.numeric(max(run.agg$Date_Index[run.agg$Season=="Summer"&run.agg$Bird_ID=="B12"], na.rm=T))
# b13<-as.numeric(max(run.agg$Date_Index[run.agg$Season=="Summer"&run.agg$Bird_ID=="B13"], na.rm=T))
# b14<-as.numeric(max(run.agg$Date_Index[run.agg$Season=="Summer"&run.agg$Bird_ID=="B14"], na.rm=T))
# b15<-as.numeric(max(run.agg$Date_Index[run.agg$Season=="Summer"&run.agg$Bird_ID=="B15"], na.rm=T))
# b16<-as.numeric(max(run.agg$Date_Index[run.agg$Season=="Summer"&run.agg$Bird_ID=="B16"], na.rm=T))
# 
# sum_last_day<-c(b1,b3,b4,b6,b7,b9,b10,b11,b12,b13,b14,b15,b16)
# 
# min(sum_last_day,na.rm=T)
# mean(sum_last_day,na.rm=T)
# #DAY 81
# median(sum_last_day,na.rm=T)
# max(sum_last_day)
# sum_last_day<-as.numeric(as.character(sum_last_day))
# sum_last_day<-data.frame(sum_last_day)
# ggplot(data=sum_last_day)+
#   geom_boxplot(aes(y=sum_last_day))+my_theme
# 
# 
# run.agg$Date_Index[run.agg$Run_ID=="B8_8.11.19"] #this is the first high point of B8
# #72- a reasonable time for a bird to start fattening, certainly not the earliest (2nd i think)
# 
# run.agg$SeasonX<-run.agg$Season
# run.agg$Season[run.agg$Season=="Non-Fattener" & run.agg$Date_Index<72 &run.agg$Bird_ID=="B8"]<-"Summer"
# run.agg$Season[run.agg$Season=="Non-Fattener" & run.agg$Date_Index<81 &run.agg$Bird_ID=="B5"]<-"Summer"
# run.agg$Season[run.agg$Season=="Non-Fattener" & run.agg$Date_Index<81 &run.agg$Bird_ID=="B2"]<-"Summer"
# #run.agg$SeasonX[run.agg$Season=="Non-Fattener" & run.agg$Date_Index<72]<-"Summer"

################################################################################

#write an updated csv file to use for plotting
#this is normally turned off when testing and writing this code.
#write.csv(run.agg, "run_agg.csv")

################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################

#PROPENSITY FUNCTION 
#use run.agg to create this dataframe. 

prop_func<-function(BIRDID){
    
    #calculate the amount of runs total in this period
    total_Summer<-length(run.agg[run.agg$Bird_ID==BIRDID & run.agg$Season=="Summer",1])
    #calculate the amount of torpid runs in this period
    torpor_Summer<-length(run.agg[run.agg$Bird_ID==BIRDID & run.agg$Torpor_Use=="TORPOR" & run.agg$Season=="Summer",1])
    
    #calculate the amount of runs total in this period
    total_Fattening<-length(run.agg[run.agg$Bird_ID==BIRDID & run.agg$Season=="Fattening",1])
    #calculate the amount of torpid runs  in this period
    torpor_Fattening<-length(run.agg[run.agg$Bird_ID==BIRDID & run.agg$Torpor_Use=="TORPOR" & run.agg$Season=="Fattening",1])
  
    #calculate the amount of runs total in this period
    total_Migration<-length(run.agg[run.agg$Bird_ID==BIRDID & run.agg$Season=="Migration",1])
    #calculate the amount of torpid runs in this period
    torpor_Migration<-length(run.agg[run.agg$Bird_ID==BIRDID & run.agg$Torpor_Use=="TORPOR" & run.agg$Season=="Migration",1])
    
    #calculate the amount of runs total in this period
    total_NonFattener<-length(run.agg[run.agg$Bird_ID==BIRDID & run.agg$Season=="Non-Fattener",1])
    #calculate the amount of torpid runs in this period
    torpor_NonFattener<-length(run.agg[run.agg$Bird_ID==BIRDID & run.agg$Torpor_Use=="TORPOR" & run.agg$Season=="Non-Fattener",1])
  
    ############################################################################
    ############################################################################
    
    #calculate the proportion of nights spent torpid in this period
    prop_torpor_Summer<- torpor_Summer/ total_Summer
    #generate a dataframe for  this period for this bird
    prop_torpor_Summer<-data.frame(prop_torpor_Summer)
    prop_torpor_Summer$Season<-"Summer"
    prop_torpor_Summer$Bird_ID<-BIRDID
    prop_torpor_Summer$SeasonCombo<-NA
    prop_torpor_Summer
    names(prop_torpor_Summer)<-c("Torpor_Propensity", "Season", "Bird_ID","SeasonCombo")
    
    #calculate the proportion of nights spent torpid in this period
    prop_torpor_Fattening<- torpor_Fattening/ total_Fattening
    #generate a dataframe for the this period for this bird
    prop_torpor_Fattening<-data.frame(prop_torpor_Fattening)
    prop_torpor_Fattening$Season<-"Fattening"
    prop_torpor_Fattening$Bird_ID<-BIRDID
    prop_torpor_Fattening$SeasonCombo<-NA
    names(prop_torpor_Fattening)<-c("Torpor_Propensity", "Season", "Bird_ID","SeasonCombo")

    #calculate the proportion of nights spent torpid in this period
    prop_torpor_Migration<-torpor_Migration/ total_Migration
    #generate a dataframe for this period for this bird
    prop_torpor_Migration<-data.frame(prop_torpor_Migration)
    prop_torpor_Migration$Season<-"Migration"
    prop_torpor_Migration$Bird_ID<-BIRDID
    prop_torpor_Migration$SeasonCombo<-NA
    names(prop_torpor_Migration)<-c("Torpor_Propensity", "Season", "Bird_ID","SeasonCombo")
  
    #calculate the proportion of nights spent torpid in this period
    prop_torpor_NonFattener<- torpor_NonFattener/ total_NonFattener
    #generate a dataframe for this period for this bird
    prop_torpor_NonFattener<-data.frame(prop_torpor_NonFattener)
    prop_torpor_NonFattener$Season<-"Non-Fattener"
    prop_torpor_NonFattener$Bird_ID<-BIRDID
    prop_torpor_NonFattener$SeasonCombo<-NA
    names(prop_torpor_NonFattener)<-c("Torpor_Propensity", "Season", "Bird_ID","SeasonCombo")
  
    ############################################################################
    ############################################################################
    #Merge all the periods into one dataframe, named props 
    props<-rbind(prop_torpor_Summer,prop_torpor_Fattening,prop_torpor_Migration,prop_torpor_NonFattener) #,prop_torpor_Fattening
    #label bird id for each bird
    props$Bird_ID<-BIRDID

return(props)
}#END PROPENSITY FUNCITON 

################################################################################

#GENERATE THESE DATAFRAMES AND THEN MERGE TO CREATE A SMALL TABLE WITH FREQUENCIES AND PROPENSITIES FOR SummerING AND MigrationRATION SEASONS FOR EACH BIRD. 
prop_b1<-prop_func("B1")
prop_b2<-prop_func("B2")
prop_b3<-prop_func("B3")
prop_b4<-prop_func("B4")
prop_b5<-prop_func("B5")
prop_b6<-prop_func("B6")
prop_b7<-prop_func("B7")
prop_b8<-prop_func("B8")
prop_b9<-prop_func("B9")
prop_b10<-prop_func("B10")
prop_b11<-prop_func("B11")
prop_b12<-prop_func("B12")
prop_b13<-prop_func("B13")
prop_b14<-prop_func("B14")
prop_b15<-prop_func("B15")
prop_b16<-prop_func("B16")

#MERGE ALL THE FREQUENCY/PROP FOR EACH BIRD INTO ONE DATAFRAME 
prop<-data.frame(rbind(prop_b1,prop_b2,prop_b3,prop_b4,prop_b5,
                       prop_b6,prop_b7,prop_b8,prop_b9,prop_b10,
                       prop_b11,prop_b12,prop_b13,prop_b14,prop_b15,
                       prop_b16))

prop
################################################################################
#correct the structures of a few variables 
prop$Bird_ID<-factor(prop$Bird_ID, levels= c("B1","B2","B3","B4","B5", "B6","B7","B8","B9","B10","B11","B12","B13","B14","B15","B16", ordered=T))
prop$Season<-factor(prop$Season, levels= c("Summer","Fattening","Migration","Non-Fattener"))#,"Fat_Mig",

#label the nonfattners
prop$Season[prop$Bird_ID %in% c("B2", "B5","B8")]<-"Non-Fattener"

################################################################################
################################################################################
#write an updated csv file to use for plotting
#this is normally turned off when testing and writing this code.
#write.csv(prop, "prop_final.csv")

################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################

#LOAD IN FOOD CONSUMPTION DATA
food.data<-(read.csv("food_data.csv"))
################################################################################

#subset out only birds 1-16 (birds that are all adults (except for 5) and i have fairly consitent data for.
bird_ids<-c("B1","B2","B3","B4","B5","B6","B7","B8","B9","B10","B11","B12","B13","B14","B15","B16")
food.data<-food.data[food.data$Bird_ID %in% bird_ids ,]#& is.na(qmr.seasoned$Season)==F

################################################################################
#get rid of dilute data cuz its fucked up
food.data$Food_Intake[food.data$Spoilage=="dilute"]<-NA

################################################################################

#correct the str of bird id
food.data$Bird_ID<-as.character(food.data$Bird_ID)

food.data$Food_Intake<-as.numeric(food.data$Food_Intake)

food.data$Season<-factor(food.data$Season, levels=c("Summer", "Fattening", "Migration","Non-Fattener"),ordered = F)

################################################################################
################################################################################
#write an updated csv file to use for plotting
#this is normally turned off when testing and writing this code.
#write.csv(food.data, "food_data_plot.csv")

################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################

#PERIOD.CUTOFFS

#READ IN PERIOD CUTOFFS (THIS IS ALREADY IN THE RQFINAL DATA BUT I NEED IT FOR FOOD CONSUMPTION DATA)
period.cutoffs<-read.csv("season_cutoffs.csv")
################################################################################

period.cutoffs$Bird_ID<-as.character(period.cutoffs$BIRD_ID)

period.cutoffs$Bird_ID<-as.factor(period.cutoffs$BIRD_ID)

################################################################################
################################################################################

#CALCULATE FATTENING PERIOD SPECIFIC VARIABLES

################################################################################

#calculate mean torpor duration in the fattening season, per bird, and pop that into period.cuttoffs 
period.cutoffs$Fattening_TorDur_mean<-NA
period.cutoffs$Fattening_TorDur_mean[period.cutoffs$BIRD_ID=="B1"]<-mean(run.agg$Torpor_Duration_ET_h[run.agg$Bird_ID=="B1"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_TorDur_mean[period.cutoffs$BIRD_ID=="B2"]<-mean(run.agg$Torpor_Duration_ET_h[run.agg$Bird_ID=="B2"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_TorDur_mean[period.cutoffs$BIRD_ID=="B3"]<-mean(run.agg$Torpor_Duration_ET_h[run.agg$Bird_ID=="B3"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_TorDur_mean[period.cutoffs$BIRD_ID=="B4"]<-mean(run.agg$Torpor_Duration_ET_h[run.agg$Bird_ID=="B4"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_TorDur_mean[period.cutoffs$BIRD_ID=="B4"]<-0
period.cutoffs$Fattening_TorDur_mean[period.cutoffs$BIRD_ID=="B5"]<-mean(run.agg$Torpor_Duration_ET_h[run.agg$Bird_ID=="B5"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_TorDur_mean[period.cutoffs$BIRD_ID=="B6"]<-mean(run.agg$Torpor_Duration_ET_h[run.agg$Bird_ID=="B6"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_TorDur_mean[period.cutoffs$BIRD_ID=="B7"]<-mean(run.agg$Torpor_Duration_ET_h[run.agg$Bird_ID=="B7"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_TorDur_mean[period.cutoffs$BIRD_ID=="B8"]<-mean(run.agg$Torpor_Duration_ET_h[run.agg$Bird_ID=="B8"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_TorDur_mean[period.cutoffs$BIRD_ID=="B9"]<-mean(run.agg$Torpor_Duration_ET_h[run.agg$Bird_ID=="B9"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_TorDur_mean[period.cutoffs$BIRD_ID=="B9"]<-0
period.cutoffs$Fattening_TorDur_mean[period.cutoffs$BIRD_ID=="B10"]<-mean(run.agg$Torpor_Duration_ET_h[run.agg$Bird_ID=="B10"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_TorDur_mean[period.cutoffs$BIRD_ID=="B11"]<-mean(run.agg$Torpor_Duration_ET_h[run.agg$Bird_ID=="B11"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_TorDur_mean[period.cutoffs$BIRD_ID=="B12"]<-mean(run.agg$Torpor_Duration_ET_h[run.agg$Bird_ID=="B12"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_TorDur_mean[period.cutoffs$BIRD_ID=="B12"]<-0
period.cutoffs$Fattening_TorDur_mean[period.cutoffs$BIRD_ID=="B13"]<-mean(run.agg$Torpor_Duration_ET_h[run.agg$Bird_ID=="B13"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_TorDur_mean[period.cutoffs$BIRD_ID=="B14"]<-mean(run.agg$Torpor_Duration_ET_h[run.agg$Bird_ID=="B14"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_TorDur_mean[period.cutoffs$BIRD_ID=="B15"]<-mean(run.agg$Torpor_Duration_ET_h[run.agg$Bird_ID=="B15"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_TorDur_mean[period.cutoffs$BIRD_ID=="B16"]<-mean(run.agg$Torpor_Duration_ET_h[run.agg$Bird_ID=="B16"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_TorDur_mean[period.cutoffs$BIRD_ID=="B16"]<-0

################################################################################
#I ACTUALLY DONT USE THIS and i dont think there is anything interesting anyway. 
#calculate mean torpor threshold in the fattening season, per bird, and pop that into period.cuttoffs 
period.cutoffs$Fattening_Thresh_mean<-NA
period.cutoffs$Fattening_Thresh_mean[period.cutoffs$BIRD_ID=="B1"]<-mean(run.agg$Crit_Fat_p[run.agg$Bird_ID=="B1"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_Thresh_mean[period.cutoffs$BIRD_ID=="B2"]<-mean(run.agg$Crit_Fat_p[run.agg$Bird_ID=="B2"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_Thresh_mean[period.cutoffs$BIRD_ID=="B3"]<-mean(run.agg$Crit_Fat_p[run.agg$Bird_ID=="B3"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_Thresh_mean[period.cutoffs$BIRD_ID=="B4"]<-mean(run.agg$Crit_Fat_p[run.agg$Bird_ID=="B4"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_Thresh_mean[period.cutoffs$BIRD_ID=="B5"]<-mean(run.agg$Crit_Fat_p[run.agg$Bird_ID=="B5"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_Thresh_mean[period.cutoffs$BIRD_ID=="B6"]<-mean(run.agg$Crit_Fat_p[run.agg$Bird_ID=="B6"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_Thresh_mean[period.cutoffs$BIRD_ID=="B7"]<-mean(run.agg$Crit_Fat_p[run.agg$Bird_ID=="B7"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_Thresh_mean[period.cutoffs$BIRD_ID=="B8"]<-mean(run.agg$Crit_Fat_p[run.agg$Bird_ID=="B8"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_Thresh_mean[period.cutoffs$BIRD_ID=="B9"]<-mean(run.agg$Crit_Fat_p[run.agg$Bird_ID=="B9"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_Thresh_mean[period.cutoffs$BIRD_ID=="B10"]<-mean(run.agg$Crit_Fat_p[run.agg$Bird_ID=="B10"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_Thresh_mean[period.cutoffs$BIRD_ID=="B11"]<-mean(run.agg$Crit_Fat_p[run.agg$Bird_ID=="B11"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_Thresh_mean[period.cutoffs$BIRD_ID=="B12"]<-mean(run.agg$Crit_Fat_p[run.agg$Bird_ID=="B12"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_Thresh_mean[period.cutoffs$BIRD_ID=="B13"]<-mean(run.agg$Crit_Fat_p[run.agg$Bird_ID=="B13"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_Thresh_mean[period.cutoffs$BIRD_ID=="B14"]<-mean(run.agg$Crit_Fat_p[run.agg$Bird_ID=="B14"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_Thresh_mean[period.cutoffs$BIRD_ID=="B15"]<-mean(run.agg$Crit_Fat_p[run.agg$Bird_ID=="B15"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)
period.cutoffs$Fattening_Thresh_mean[period.cutoffs$BIRD_ID=="B16"]<-mean(run.agg$Crit_Fat_p[run.agg$Bird_ID=="B16"&run.agg$Torpor_Use=="TORPOR"&run.agg$Season=="Fattening"],na.rm=T)

################################################################################

#calculate mean torpor threshold in the fattening season, per bird, and pop that into period.cuttoffs 
period.cutoffs$Fattening_Prop_mean<-NA
period.cutoffs$Fattening_Prop_mean[period.cutoffs$BIRD_ID=="B1"]<-prop$Torpor_Propensity[prop$Bird_ID=="B1"&prop$Season=="Fattening"][1]
#period.cutoffs$Fattening_Prop_mean[period.cutoffs$BIRD_ID=="B2"]<-prop$Torpor_Propensity[prop$Bird_ID=="B2"&prop$Season=="Fattening"][1]
period.cutoffs$Fattening_Prop_mean[period.cutoffs$BIRD_ID=="B3"]<-prop$Torpor_Propensity[prop$Bird_ID=="B3"&prop$Season=="Fattening"][1]
period.cutoffs$Fattening_Prop_mean[period.cutoffs$BIRD_ID=="B4"]<-prop$Torpor_Propensity[prop$Bird_ID=="B4"&prop$Season=="Fattening"][1]
#period.cutoffs$Fattening_Prop_mean[period.cutoffs$BIRD_ID=="B5"]<-prop$Torpor_Propensity[prop$Bird_ID=="B5"&prop$Season=="Fattening"][1]
period.cutoffs$Fattening_Prop_mean[period.cutoffs$BIRD_ID=="B6"]<-prop$Torpor_Propensity[prop$Bird_ID=="B6"&prop$Season=="Fattening"][1]
period.cutoffs$Fattening_Prop_mean[period.cutoffs$BIRD_ID=="B7"]<-prop$Torpor_Propensity[prop$Bird_ID=="B7"&prop$Season=="Fattening"][1]
#period.cutoffs$Fattening_Prop_mean[period.cutoffs$BIRD_ID=="B8"]<-prop$Torpor_Propensity[prop$Bird_ID=="B8"&prop$Season=="Fattening"][1]
period.cutoffs$Fattening_Prop_mean[period.cutoffs$BIRD_ID=="B9"]<-prop$Torpor_Propensity[prop$Bird_ID=="B9"&prop$Season=="Fattening"][1]
period.cutoffs$Fattening_Prop_mean[period.cutoffs$BIRD_ID=="B10"]<-prop$Torpor_Propensity[prop$Bird_ID=="B10"&prop$Season=="Fattening"][1]
period.cutoffs$Fattening_Prop_mean[period.cutoffs$BIRD_ID=="B11"]<-prop$Torpor_Propensity[prop$Bird_ID=="B11"&prop$Season=="Fattening"][1]
period.cutoffs$Fattening_Prop_mean[period.cutoffs$BIRD_ID=="B12"]<-prop$Torpor_Propensity[prop$Bird_ID=="B12"&prop$Season=="Fattening"][1]
period.cutoffs$Fattening_Prop_mean[period.cutoffs$BIRD_ID=="B13"]<-prop$Torpor_Propensity[prop$Bird_ID=="B13"&prop$Season=="Fattening"][1]
period.cutoffs$Fattening_Prop_mean[period.cutoffs$BIRD_ID=="B14"]<-prop$Torpor_Propensity[prop$Bird_ID=="B14"&prop$Season=="Fattening"][1]
period.cutoffs$Fattening_Prop_mean[period.cutoffs$BIRD_ID=="B15"]<-prop$Torpor_Propensity[prop$Bird_ID=="B15"&prop$Season=="Fattening"][1]
period.cutoffs$Fattening_Prop_mean[period.cutoffs$BIRD_ID=="B16"]<-prop$Torpor_Propensity[prop$Bird_ID=="B16"&prop$Season=="Fattening"][1]
period.cutoffs$Fattening_Prop_mean[period.cutoffs$BIRD_ID=="B17"]<-prop$Torpor_Propensity[prop$Bird_ID=="B17"&prop$Season=="Fattening"][1]

################################################################################

#FOOD INTAKE- PER BIRD MEANS WITHIN THE MIGRATION SEASSON
period.cutoffs$Fattening_Food_mean<-NA
period.cutoffs$Fattening_Food_mean[period.cutoffs$BIRD_ID=="B1"]<-mean(food.data$Food_Intake[food.data$Season=="Fattening"&food.data$Bird_ID=="B1"],na.rm=T)#explore relationships within the fattening period. 
period.cutoffs$Fattening_Food_mean[period.cutoffs$BIRD_ID=="B2"]<-mean(food.data$Food_Intake[food.data$Season=="Fattening"&food.data$Bird_ID=="B2"],na.rm=T)
period.cutoffs$Fattening_Food_mean[period.cutoffs$BIRD_ID=="B3"]<-mean(food.data$Food_Intake[food.data$Season=="Fattening"&food.data$Bird_ID=="B3"],na.rm=T)
period.cutoffs$Fattening_Food_mean[period.cutoffs$BIRD_ID=="B4"]<-mean(food.data$Food_Intake[food.data$Season=="Fattening"&food.data$Bird_ID=="B4"],na.rm=T)
period.cutoffs$Fattening_Food_mean[period.cutoffs$BIRD_ID=="B5"]<-mean(food.data$Food_Intake[food.data$Season=="Fattening"&food.data$Bird_ID=="B5"],na.rm=T)
period.cutoffs$Fattening_Food_mean[period.cutoffs$BIRD_ID=="B6"]<-mean(food.data$Food_Intake[food.data$Season=="Fattening"&food.data$Bird_ID=="B6"],na.rm=T)
period.cutoffs$Fattening_Food_mean[period.cutoffs$BIRD_ID=="B6"]<-mean(food.data$Food_Intake[food.data$Season=="Fattening"&food.data$Bird_ID=="B7"],na.rm=T)
period.cutoffs$Fattening_Food_mean[period.cutoffs$BIRD_ID=="B8"]<-mean(food.data$Food_Intake[food.data$Season=="Fattening"&food.data$Bird_ID=="B8"],na.rm=T)
period.cutoffs$Fattening_Food_mean[period.cutoffs$BIRD_ID=="B9"]<-mean(food.data$Food_Intake[food.data$Season=="Fattening"&food.data$Bird_ID=="B9"],na.rm=T)
period.cutoffs$Fattening_Food_mean[period.cutoffs$BIRD_ID=="B10"]<-mean(food.data$Food_Intake[food.data$Season=="Fattening"&food.data$Bird_ID=="10"],na.rm=T)
period.cutoffs$Fattening_Food_mean[period.cutoffs$BIRD_ID=="B11"]<-mean(food.data$Food_Intake[food.data$Season=="Fattening"&food.data$Bird_ID=="B11"],na.rm=T)
period.cutoffs$Fattening_Food_mean[period.cutoffs$BIRD_ID=="B12"]<-mean(food.data$Food_Intake[food.data$Season=="Fattening"&food.data$Bird_ID=="B12"],na.rm=T)
period.cutoffs$Fattening_Food_mean[period.cutoffs$BIRD_ID=="B13"]<-mean(food.data$Food_Intake[food.data$Season=="Fattening"&food.data$Bird_ID=="B13"],na.rm=T)
period.cutoffs$Fattening_Food_mean[period.cutoffs$BIRD_ID=="B14"]<-mean(food.data$Food_Intake[food.data$Season=="Fattening"&food.data$Bird_ID=="B14"],na.rm=T)
period.cutoffs$Fattening_Food_mean[period.cutoffs$BIRD_ID=="B15"]<-mean(food.data$Food_Intake[food.data$Season=="Fattening"&food.data$Bird_ID=="B15"],na.rm=T)
period.cutoffs$Fattening_Food_mean[period.cutoffs$BIRD_ID=="B16"]<-mean(food.data$Food_Intake[food.data$Season=="Fattening"&food.data$Bird_ID=="B16"],na.rm=T)

################################################################################
################################################################################
#write an updated csv file to use for plotting
#this is normally turned off when testing and writing this code.
#write.csv(period.cutoffs, "period_cutoffs_final.csv")

################################################################################
################################################################################
################################################################################
################################################################################
#add in fasted times

fast.times<-read.csv("runids_fastedtimes.csv")
runids<-unique(fast.times$Run_ID)
for(i in runids){
  run.agg$Fasted_Time[run.agg$Run_ID==i]<-fast.times$Fasted_Time[fast.times$Run_ID==i]
}

hist(run.agg$Fasted_Time)

ggplot(run.agg)+
  geom_point(aes(x=Fasted_Time, y=Torpor_Duration_ET, col=Season))+
    geom_smooth(aes(x=Fasted_Time, y=Torpor_Duration_ET, col=Season),method="lm")+
  my_theme

#[run.agg$Season=="Summer",]

ggplot(run.agg)+
  geom_point(aes(x=Fasted_Time, y=Fat_Eve_p, col=Season))+
    geom_smooth(aes(x=Fasted_Time, y=Fat_Eve_p, col=Season),method="lm")+
  my_theme

################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################

#DATA SETUP DONE

################################################################################
################################################################################
################################################################################
################################################################################

#ambient temperaturee mean +- sd
#(should just be 20c)
mean(all.data.1min$Air_Temperature, na.rm=T)
std.error(all.data.1min$Air_Temperature, na.rm=T)

################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################

#ACTUAL ANALYSIS START

################################################################################

#BODY COMPOSITION

################################################################################

#BODY MASS- SEASONAL MEANS

ggplot(data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_boxplot(aes(x= Season ,y=Body_Morn_g, col=Season), lwd=1)+
  geom_point(aes(x= Season ,y=Body_Morn_g), col="black", lwd=2)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_y_continuous(limits = c(2.25,4.5),breaks = seq(0, 5, by = .5), name = "Morning Body Mass (g)")+
#  scale_x_continuous(limits = c(20,125),breaks = seq(0, 125, by = 30),name="Date")+
    #facet_wrap(~Bird_ID)+
  my_theme

lm_full<-lmer(Body_Morn_g ~-1+Season+ 
                              (1|Bird_ID) 
                            , data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration"),], REML=F,
                            control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))
leveneTest(residuals(lm_full) ~run.agg$Season[run.agg$Season %in% c("Summer","Fattening","Migration")])
           
AIC(lm_full) 
summary(lm_full)

em<-emmeans(lm_full, pairwise~Season)
em

################################################################################

#BODY MASS- SEASONAL SLOPES VS DATE

ggplot(data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_point(aes(x= Date_Index ,y=Body_Morn_g, col=Season), lwd=2, alpha=.6)+
  geom_smooth(method="lm",aes(x=Date_Index,y=Body_Morn_g, col=Season),se=F)+
  #geom_smooth(method="lm",aes(x=Date_Index,y=Body_Morn_g, linetype=Season),col="black",se=F, lwd=2)+
    scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_y_continuous(limits = c(2.25,4.5),breaks = seq(0, 5, by = .5), name = "Morning Body Mass (g)")+
    scale_x_continuous(limits = c(20,125),breaks = seq(0, 125, by = 10),name="Date")+
  facet_wrap(~Bird_ID)+
  my_theme

lm_full<-lmer(Body_Morn_g ~-1+Season + Season:Date_Index+
                              (1+Date_Index|Bird_ID) 
                            , data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration"),], REML=F,
                            control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))
leveneTest(residuals(lm_full) ~Season , data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration"),])
plot(residuals(lm_full))

AIC(lm_full) 
summary(lm_full)

et<-emtrends(lm_full, pairwise~Season, var="Date_Index" )
et

################################################################################
################################################################################

#FAT_CONTENT- SEASONAL MEANS

ggplot(data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_boxplot(aes(x= Season ,y=Fat_Morn_p, col=Season), alpha=.4)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    geom_point(aes(x=Season,y=Fat_Morn_p),col="black")+
  my_theme

lm_full<-lmer(Fat_Morn_p ~ -1+Season+
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full)) 
plot(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

em<-emmeans(lm_full, pairwise~Season)
em

################################################################################

#FAT CONTENT- SEASONAL SLOPES VS DATE

ggplot(data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_point(aes(x= Date_Index ,y=Fat_Morn_p, col=Season), lwd=3, alpha=.4)+scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    geom_smooth(method="lm",aes(x=Date_Index,y=Fat_Morn_p, col=Season),se=F)+
  #facet_wrap(~Bird_ID)+
  my_theme

lm_full<-lmer(Fat_Morn_p ~ -1+Season+Season:Date_Index+ 
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full)) 

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, pairwise~Season, var="Date_Index" ) 
et

################################################################################
################################################################################

#LEAN MASS- SEASONAL MEANS

ggplot(data=run.agg[run.agg$Lean_Quality=="GOOD" &run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_boxplot(aes(x= Season ,y=Lean_Morn_g, col=Season), alpha=.4)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    geom_point(aes(x=Season,y=Lean_Morn_g),col="black")+
  my_theme

lm_full<-lmer(Lean_Morn_g ~ -1+Season+ 
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration") & run.agg$Lean_Quality=="GOOD"&is.na(run.agg$Lean_Morn_g)==F,], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

em<-emmeans(lm_full, pairwise~Season) 
em

################################################################################

#LEAN MASS- SEASONAL SLOPES VS DATE

ggplot(data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration") &run.agg$Lean_Quality=="GOOD",])+
  geom_point(aes(x= Date_Index ,y=Lean_Morn_g, col=Season), lwd=3, alpha=.4)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    geom_smooth(method="lm",aes(x=Date_Index,y=Lean_Morn_g, col=Season),se=F)+
  #facet_wrap(~Bird_ID)+
  my_theme

lm_full<-lmer((Lean_Morn_g) ~ -1+Season+Season:Date_Index+ 
                             (1|Bird_ID) #ADDING Date_Index MESSES UP THE BETWEEN SEASON COMPARISONS. AND THIS IS ACTUALLY A BETTER AIC
                            , data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration") &run.agg$Lean_Quality=="GOOD",], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, pairwise~Season, var="Date_Index" ) 
et

################################################################################
################################################################################

#FOOD INTAKE- SEASONAL MEANS

food.data.week<-food.data %>%
  #group by run-specific variables that have one value per run. 
  group_by(Week, Bird_ID,  Season, Day_Length) %>%
  #summarize (usually mean +- std error) variables that have multiple values per run (i.e. minute data)
  summarize(Food_Intake = mean(Food_Intake, na.rm = TRUE),
            Food_Intake_se = std.error(Food_Intake, na.rm = TRUE))%>%
          data.frame()

ggplot(data=food.data.week[food.data.week$Season %in% c("Summer","Fattening","Migration"),])+
  geom_point(aes(x= Season ,y=Food_Intake),col="black", lwd=3, alpha=.4)+
  geom_boxplot(aes(x= Season ,y=Food_Intake, col=Season), alpha=.4)+
  scale_color_manual(values=c("blue", "green","red","black", "blue"))+
      scale_y_continuous(name = "Daily Food Consumption (mL)")+
  scale_x_discrete(name="Period")+
  my_theme

lm_full<-lmer(sqrt(Food_Intake) ~ -1+Season+Day_Length+
                             (1|Bird_ID) 
                            , data=food.data.week[food.data.week$Season %in% c("Summer","Fattening","Migration")&is.na(food.data.week$Food_Intake)==F&is.na(food.data.week$Day_Length)==F,,], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e8)))

shapiro.test(residuals(lm_full)) 
hist(residuals(lm_full))
qqnorm(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

em<-emmeans(lm_full, "pairwise" ~Season)
em

#################################
#without the transformation
lm_full<-lmer((Food_Intake) ~ -1+Season+Day_Length+
                             (1|Bird_ID) 
                            , data=food.data.week[food.data.week$Season %in% c("Summer","Fattening","Migration")&is.na(food.data.week$Food_Intake)==F&is.na(food.data.week$Day_Length)==F,,], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e8)))

shapiro.test(residuals(lm_full)) #NOT NORMAL, COULD DO A SQRT TRANSFORMATION  
hist(residuals(lm_full))
qqnorm(residuals(lm_full))
plot(cooks.distance(lm_full))

AIC(lm_full)
summary(lm_full)

em<-emmeans(lm_full, "pairwise" ~Season)
em

################################################################################

#FOOD INTAKE- SEASONAL SLOPES VS DATE (week)

ggplot(data=food.data.week[food.data.week$Season %in% c("Summer","Fattening","Migration"),])+
  geom_point(aes(x= Week ,y=Food_Intake, col=Season), lwd=3, alpha=.4)+
  scale_color_manual(values=c("blue", "yellow","red","black"))+
    geom_smooth(method="lm",aes(x=Week,y=Food_Intake, col=Season),se=F)+
#      scale_y_continuous(name = "Daily Food Consumption (mL)", limits=c(0,35))+
  scale_x_continuous(name="Week since June 1", limits=c(0,18))+
  #facet_wrap(~Bird_ID)+
  my_theme
# 
# #WITH TRANSFORM
# lm_full<-lmer(sqrt(Food_Intake) ~ -1+Season+Season:Week+Season:Day_Length+#
#                              (1|Bird_ID)
#                             , data=food.data.week[food.data.week$Season %in% c("Summer","Fattening","Migration")&is.na(food.data.week$Day_Length)==F&is.na(food.data.week$Food_Intake)==F,], REML=F,
#               control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))
# 
# shapiro.test(residuals(lm_full))
# 
# AIC(lm_full)
# summary(lm_full)
# 
# et<-emtrends(lm_full, pairwise~Season, var="Week" )
# et
# 
# ####################################

#without transformation
lm_full<-lmer((Food_Intake) ~ -1+Season+Season:Week+Season:Day_Length+
                             (1|Bird_ID)  
                            , data=food.data.week[food.data.week$Season %in% c("Summer","Fattening","Migration")&is.na(food.data.week$Day_Length)==F&is.na(food.data.week$Food_Intake)==F,], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full)) #THIS IS NORMAL... NO SQRT TRANSFORM NEEDED

AIC(lm_full)
summary(lm_full)
#dev.off()

plot(allEffects(lm_full))
plot(allEffects(lm_full, partial.residuals=T))

et<-emtrends(lm_full, pairwise~Season, var="Week" )
et

et<-emtrends(lm_full, pairwise~Season, var="Day_Length" )
et


################################################################################
################################################################################

#FAT VS BODY MASS- REPEATED MEASURES CORRELATION 

ggplot(data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration"),])+
      geom_smooth(method="lm",aes(x=Body_Morn_g,y=Fat_Morn_g,group=Bird_ID),col="grey", linetype="dashed",lwd=.5,se=F,alpha=.1)+
    geom_smooth(method="lm",aes(x=Body_Morn_g,y=Fat_Morn_g),se=F, col="black",lwd=1,alpha=.1)+
 geom_smooth(method="lm",aes(x=Body_Morn_g,y=Fat_Morn_g,col=Season),lwd=.5,se=F,alpha=.1)+
    geom_point(aes(x= Body_Morn_g ,y=Fat_Morn_g, col=Season), lwd=3, alpha=.4, shape="circle")+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
  scale_y_continuous(name = "Morning Fat Mass (g)")+
  scale_x_continuous(name="Morning Body Mass (g)")+
  my_theme+theme(legend.position="none")

body.fat <- rmcorr(Bird_ID, Body_Morn_g, (Fat_Morn_g)^2, dataset=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration"),], nreps = 100, bstrap.out = F)
body.fat.r<-round(as.numeric(body.fat[1]),digits=3)
body.fat.p<-round(as.numeric(body.fat[3]),3)
body.fat.slope<-round(as.numeric(last(body.fat$model$coefficients)),3)
body.fat.yint<-round(as.numeric(body.fat$model$coefficients[1]),3)

shapiro.test(body.fat$model$residuals) #doing a ^2 transformation makes this  normal

body.fat 
#summary(body.fat)
body.fat.r
body.fat.p 
body.fat.slope
body.fat.yint 

################################################################################
################################################################################

#LEAN VS BODY MASS- REPEATED MEASURES CORRELATION

ggplot(data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration")&&run.agg$Lean_Quality=="GOOD"&is.na(run.agg$Lean_Morn_g)==F,])+
        geom_smooth(method="lm",aes(x=Body_Morn_g,y=Lean_Morn_g,group=Bird_ID),col="grey", linetype="dashed",lwd=.5,se=F,alpha=.1)+
    geom_smooth(method="lm",aes(x=Body_Morn_g,y=Lean_Morn_g),se=F, col="black",lwd=.5,alpha=.1)+
    #geom_smooth(method="lm",aes(x=Body_Morn_g,y=Lean_Morn_g,col=Season),lwd=.5,se=F,alpha=.1)+
  geom_point(aes(x= Body_Morn_g ,y=Lean_Morn_g, col=Season), lwd=3, alpha=.4, shape="circle")+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
  
  my_theme

body.lean <- rmcorr(Bird_ID, Body_Morn_g, Lean_Morn_g, dataset=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration")&run.agg$Lean_Quality=="GOOD"&is.na(run.agg$Lean_Morn_g)==F,])
body.lean.r<-round(as.numeric(body.lean[1]),digits=3)
body.lean.p<-round(as.numeric(body.lean[3]),3)
body.lean.slope<-round(as.numeric(last(body.lean$model$coefficients)),3)
body.lean.yint<-round(as.numeric(body.lean$model$coefficients[1]),3)

shapiro.test(body.lean$model$residuals)

body.lean
body.lean.r 
body.lean.p 
body.lean.slope 
body.lean.yint

################################################################################
#END BODY COMPOSITION MODELS
################################################################################
################################################################################

#FAT_CONTENT- SEASONAL MEANS

ggplot(data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_boxplot(aes(x= Season ,y=Fat_Eve_p, col=Season), alpha=.4)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    geom_point(aes(x=Season,y=Fat_Eve_p),col="black")+
  my_theme

lm_full<-lmer(Fat_Eve_p ~ -1+Season+Night_Duration+
                            (1|Bird_ID) 
                            , data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full)) 

AIC(lm_full)
summary(lm_full)

em<-emmeans(lm_full, pairwise~Season)
em

plot(allEffects(lm_full))
plot(allEffects(lm_full, partial.residuals=T))

################################################################################

#FAT CONTENT- SEASONAL SLOPES VS DATE

ggplot(data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_point(aes(x= Date_Index ,y=Fat_Eve_p, col=Season), lwd=3, alpha=.4)+scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    geom_smooth(method="lm",aes(x=Date_Index,y=Fat_Eve_p, col=Season),se=F)+
  #facet_wrap(~Bird_ID)+
  my_theme

lm_full<-lmer(Fat_Eve_p ~ -1+Season+Season:Date_Index+ Season:Night_Duration+
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full)) 


AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, pairwise~Season, var="Date_Index" ) #####SHIIIIIITTTTT
et

plot(allEffects(lm_full))
plot(allEffects(lm_full, partial.residuals=T))

################################################################################
################################################################################

#DRIVERS OF FATTENING PERIOD

################################################################################

#BODY MASS GAINS DURING FATTENING VS TORPOR DURATOIN

#best model is just torpor duration model model, but since food is 
#of explicit interest I still use the full model. 

ggplot(data=period.cutoffs)+
  geom_point(aes(x=Fattening_TorDur_mean,y=Body_gi_F))+
  geom_smooth(method="lm",aes(x=Fattening_TorDur_mean,y=Body_gi_F),se=T)+
      scale_y_continuous(name="Body Mass Gains During Fattening (g)")+
  scale_x_continuous(name="Mean Torpor Duration During Fattening (hrs)")+
  my_theme

ggplot(data=period.cutoffs)+
  geom_point(aes(x=Fattening_Food_mean,y=Body_gi_F))+
  geom_smooth(method="lm",aes(x=Fattening_Food_mean,y=Body_gi_F),se=T)+
      scale_y_continuous(name="Body Mass Gains During Fattening (g)")+
  scale_x_continuous(name="Daily Food Consumption During Fattening (mL)")+
  my_theme

lm_full<-lm(Body_gi_F~ Fattening_TorDur_mean+Fattening_Food_mean
           , data=period.cutoffs[is.na(period.cutoffs$Fattening_TorDur_mean)==F,])

shapiro.test(residuals(lm_full))

summary(lm_full)

################################################################################
################################################################################

#FATTENING DURATION GAINS DURING FATTENING VS TORPOR DURATOIN
ggplot(data=period.cutoffs)+
  geom_point(aes(x=Fattening_TorDur_mean,y=Fat_Duration))+
  geom_smooth(method="lm",aes(x=Fattening_TorDur_mean,y=Fat_Duration),se=T)+
     scale_y_continuous(name="Fattening Period Duration (days)")+
  scale_x_continuous(name="Mean Torpor Duration During Fattening (hrs)")+
  my_theme

#FATTENING DURATION GAINS DURING FATTENING VS MEAN FOOD INTAKE DURING Fattening 
ggplot(data=period.cutoffs)+
  geom_point(aes(x=Fattening_Food_mean,y=Fat_Duration))+
  geom_smooth(method="lm",aes(x=Fattening_Food_mean,y=Fat_Duration),se=T)+
    scale_y_continuous(name="Fattening Period Duration (days)")+
  scale_x_continuous(name="Mean Food Consumption During Fattening (mL)")+
  my_theme

lm_full<-lm(Fat_Duration~Fattening_TorDur_mean+Fattening_Food_mean 
           , data=period.cutoffs[is.na(period.cutoffs$Fattening_TorDur_mean)==F,])

shapiro.test(residuals(lm_full))

summary(lm_full)

################################################################################
#END FATTENING PERIOD MODELS
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################

#TORPOR USE

#turn night duration into hours 
run.agg$Night_Duration<-run.agg$Night_Duration/60
run.agg$Crit_Time_h<-(run.agg$Crit_Time_p/100)*run.agg$Night_Duration

################################################################################

#TORPOR PROPESITY- SEASONAL MEANS

ggplot(data=prop[prop$Season %in% c("Summer","Fattening","Migration"),])+
  geom_boxplot(aes(x=Season, y=Torpor_Propensity, col=Season))+
  geom_point(aes(x=Season, y=Torpor_Propensity))+
  my_theme

lm_full<-lmer(Torpor_Propensity ~ -1+Season+
                             (1|Bird_ID) 
                            , data=prop[prop$Season %in% c("Summer","Fattening","Migration"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

em<-emmeans(lm_full, pairwise~Season)
em

################################################################################
################################################################################

#PROBABILITY OF TORPOR USE- LOGISTIC REGRESSION- SEASONAL SLOPES

ggplot(data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration"),])+ 
  geom_point(aes(x=Fat_Eve_p, y=Torpor_Use_bin, color=Season), alpha=.4, lwd=3)+scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_shape_manual(values = c(16,1,17,18,19))+
    geom_smooth(method="glm",aes(x=Fat_Eve_p, y=Torpor_Use_bin, color=Season),method.args=list(family="binomial"),se=F,fullrange=T)+
      scale_y_continuous(name = "Probability of Torpor Use")+
  scale_x_continuous(name="Eveing Fat Content (%)")+
  #scale_x_continuous(limits=c(2,5))+
  my_theme

lm_full<-glmer(Torpor_Use_bin ~-1+Season+Season:Fat_Eve_p+
                             (1|Bird_ID) #
                            , data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration"),],family = "binomial",)
                                           #control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full) 
summary(lm_full)

et<-emtrends(lm_full, pairwise~Season, var="Fat_Eve_p")
et

#night duration doesnt let model run properly. 

############
#do a separate model for night length's effect on torpor propensity

ggplot(data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration"),])+ 
  geom_point(aes(x=Night_Duration, y=Torpor_Use_bin, color=Season), alpha=.4, lwd=3)+scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_shape_manual(values = c(16,1,17,18,19))+
    geom_smooth(method="glm",aes(x=Night_Duration, y=Torpor_Use_bin, color=Season),method.args=list(family="binomial"),se=F,fullrange=T)+
      scale_y_continuous(name = "Probability of Torpor Use")+
  scale_x_continuous(name="Night Length (Hours)")+
  #scale_x_continuous(limits=c(2,5))+
  my_theme

lm_full<-glmer((Torpor_Use_bin) ~-1+Season+Season:Night_Duration+
                             (1|Bird_ID) #
                            , data=run.agg[run.agg$Season %in% c("Summer","Fattening","Migration"),],family = "binomial",
                                           control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e8)))

AIC(lm_full) 
summary(lm_full)

et<-emtrends(lm_full, pairwise~Season, var="Night_Duration")
et

################################################################################
################################################################################

#TORPOR DURATION- SEASONAL MEANS- USING DURATION AS HOURS

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"& run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_boxplot(aes(x=Season, y=Torpor_Duration_ET_h, color=Season), alpha=.2, lwd=1)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
  geom_point(aes(x=Season, y=Torpor_Duration_ET_h), col="black",alpha=.8, lwd=2)+
      scale_y_continuous(name = "Torpor Duration (hrs)",limits=c(0,10))+
  my_theme

lm_full<-lmer(Torpor_Duration_ET_h ~ -1+Season+Night_Duration+
                             (1|Bird_ID) 
                            ,data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Summer","Fattening","Migration"),], REML = F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

em<-emmeans(lm_full, pairwise ~ Season)
em

################################################################################

#TORPOR DURATION- SEASONAL SLOPES VS FAT- USING DURATION AS HOURS

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"& run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_point(aes(x=Fat_Eve_p, y=Torpor_Duration_ET_h, color=Season), alpha=.4, lwd=2)+
    scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_shape_manual(values = c(16,1,17,18,19))+
  geom_smooth(method="lm",aes(x=Fat_Eve_p, y=Torpor_Duration_ET_h, col=Season),se=F)+
        scale_y_continuous(name = "Torpor Duration (hrs)",limits=c(0,10))+
      scale_x_continuous(name="Evening Fat Content (%)")+
  my_theme

lm_full<-lmer(Torpor_Duration_ET_h ~ -1+Season+Season:Fat_Eve_p+Season:Night_Duration+ 
                             (1+Fat_Eve_p|Bird_ID) 
                            ,data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Summer","Fattening","Migration"),], REML = F,
                            control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, pairwise~Season, var="Fat_Eve_p")
et

et<-emtrends(lm_full, pairwise~Season, var="Night_Duration")
et

################################################################################
################################################################################

#PRETORPOR ENERGY EXPENDITURE- SEASONAL MEANS

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"& run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_boxplot(aes(x=Season, y=Fat_Loss_pretorpor_kJ, color=Season), alpha=.2, lwd=1)+scale_color_manual(values=c("blue", "green","red","black", "grey"))+
  geom_point(aes(x=Season, y=Fat_Loss_pretorpor_kJ), col="black",alpha=.8, lwd=2)+
 #scale_y_continuous(limits=c(0,7), name="Pretorpor Fat Expenditure (kJ)")+
  my_theme

lm_full<-lmer(Fat_Loss_pretorpor_kJ ~ -1+Season+Night_Duration+
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Summer","Fattening","Migration"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full)) 
AIC(lm_full)
summary(lm_full)

em<-emmeans(lm_full, pairwise~Season)
em

################################################################################

#PRETORPOR ENERGY EXPENDITURE- SEASONAL SLOPES VS FAT

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_point(aes(x=Fat_Eve_p, y=Fat_Loss_pretorpor_kJ, color=Season), alpha=.8, lwd=2)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_shape_manual(values = c(16,1,17,18,19))+
    geom_smooth(method="lm",aes(x=Fat_Eve_p, y=Fat_Loss_pretorpor_kJ, col=Season),se=F)+
  #scale_y_continuous(limits=c(0,10))+
  scale_y_continuous(name="Pretorpor Fat Expenditure (kJ)")+
  my_theme

lm_full<-lmer(Fat_Loss_pretorpor_kJ ~ -1+Season+Season:Fat_Eve_p+Season:Night_Duration+
                             (1+Fat_Eve_p|Bird_ID) 
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Summer","Fattening","Migration"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, pairwise~Season, var="Fat_Eve_p")
et

et<-emtrends(lm_full, pairwise~Season, var="Night_Duration")
et

################################################################################
################################################################################

#TORPOR ENTRY TIME- SEASONAL MEANS

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"& run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_boxplot(aes(x=Season, y=Crit_Time_h, color=Season), alpha=.2, lwd=1)+scale_color_manual(values=c("blue", "green","red","black", "grey"))+
  geom_point(aes(x=Season, y=Crit_Time_h), col="black",alpha=.8, lwd=2)+
  scale_y_continuous(limits=c(0,10), name="Time of Entry (minute of night)")+
  my_theme

lm_full<-lmer(Crit_Time_h~ -1+Season+Night_Duration+
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Summer","Fattening","Migration"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))   

AIC(lm_full)
summary(lm_full)

em<-emmeans(lm_full, pairwise~Season)
em

################################################################################

#TORPOR ENTRY TIME- SLOPES VS FAT

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"& run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_point(aes(x=Fat_Eve_p, y=Crit_Time_h, color=Season), alpha=.8, lwd=2)+scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_shape_manual(values = c(16,1,17,18,19))+
    geom_smooth(method="lm",aes(x=Fat_Eve_p, y=Crit_Time_h, col=Season),se=F)+
  #scale_y_continuous(limits=c(0,10))+
  my_theme

lm_full<-lmer(Crit_Time_h ~ -1+Season+Season:Fat_Eve_p+Season:Night_Duration+
                             (1+Fat_Eve_p|Bird_ID) 
                , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Summer","Fattening","Migration"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))


shapiro.test(residuals(lm_full)) 

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, pairwise~Season, var="Fat_Eve_p")
et

et<-emtrends(lm_full, pairwise~Season, var="Night_Duration")
et

################################################################################
################################################################################

#TORPOR ENTRY FAT LEVELS - SEASONAL MEANS

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"& run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_boxplot(aes(x=Season, y=Crit_Fat_p, color=Season), alpha=.2, lwd=1)+scale_color_manual(values=c("blue", "green","red","black", "grey"))+
  geom_point(aes(x=Season, y=Crit_Fat_p), col="black",alpha=.8, lwd=2)+
 scale_y_continuous(limits=c(0,45), name="Fat % at Torpor Entry")+
  my_theme

lm_full<-lmer(Crit_Fat_p ~ -1+Season+
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Summer","Fattening","Migration"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full) 
summary(lm_full)

em<-emmeans(lm_full, pairwise~Season)
em

#NIGHT LENGTH DOES NOT IMPROVE AIC

################################################################################

#TORPOR ENTRY FAT LEVELS - SEASONAL MEANS- ABSOLUTES
run.agg$Crit_Fat_g<-run.agg$Crit_Fat_p*.01*run.agg$Body_Morn_g

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"& run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_boxplot(aes(x=Season, y=Crit_Fat_g, color=Season), alpha=.2, lwd=1)+scale_color_manual(values=c("blue", "green","red","black", "grey"))+
  geom_point(aes(x=Season, y=Crit_Fat_g), col="black",alpha=.8, lwd=2)+
 scale_y_continuous(limits=c(0,1), name="Fat Mass (g) at Torpor Entry")+
  my_theme

lm_full<-lmer(Crit_Fat_g*100 ~ -1+Season+
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Summer","Fattening","Migration"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

emm_options(opt.digits = FALSE)

em<-emmeans(lm_full, pairwise~Season)
em

#NIGHT LENGTH DOES NOT IMPROVE AIC

################################################################################
###############################################################################

#TORPOR ENTRY FAT LEVELS- SEASONAL SLOPES VS TIME OF ENTRY

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_point(aes(x=Crit_Time_min, y=Crit_Fat_p, color=Season), alpha=.4, lwd=2)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_shape_manual(values = c(16,1,17,18,19))+
  geom_smooth(method="lm",aes(x=Crit_Time_h, y=Crit_Fat_p, col=Season),se=F)+
  #scale_y_continuous(limits=c(0,10))+
  scale_y_continuous(name="Fat Content (%) at Torpor Entry")+  
  scale_x_continuous(name="Time of Night at Entry (min)")+
  my_theme

lm_full<-lmer(Crit_Fat_p ~ -1+Season+Season:Crit_Time_h+Season:Night_Duration+  
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Summer","Fattening","Migration"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, pairwise~Season, var="Crit_Time_h")
et

et<-emtrends(lm_full, pairwise~Season, var="Night_Duration")
et

################################################################################

#TORPOR ENTRY FAT LEVELS- SEASONAL SLOPES VS DATE_INDEX
ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_point(aes(x=Date_Index, y=Crit_Fat_p, color=Season), alpha=.8, lwd=2)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_shape_manual(values = c(16,1,17,18,19))+
    geom_smooth(method="lm",aes(x=Date_Index, y=Crit_Fat_p, col=Season),se=F)+
  #scale_y_continuous(limits=c(0,10))+
  scale_y_continuous(name="Fat% at Torpor Entry")+
  my_theme

lm_full<-lmer(Crit_Fat_p ~ -1+Season+Season:Date_Index+#Night_Duration+
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Summer","Fattening","Migration"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))
  
shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, pairwise~Season, var="Date_Index")
et

#night duration does not improve aic

################################################################################
################################################################################

#TORPID OVERNIGHT FAT MASS LOSS-SEASONAL MEANS

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Run_ID!="B13_8.11.19"& run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_boxplot(aes(x=Season, y=Fat_delta_mg, color=Season), alpha=.2, lwd=1)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
  geom_point(aes(x=Season, y=Fat_delta_mg), col="black",alpha=.8, lwd=2)+
 scale_y_continuous(limits=c(0,25), name="Overnight Fat Content Loss (%)")+
  my_theme

lm_full<-lmer(Fat_delta_mg ~ -1+Season+Night_Duration+
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Run_ID!="B13_8.11.19"&run.agg$Season %in% c("Summer","Fattening","Migration"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

em<-emmeans(lm_full, pairwise~Season)
em

################################################################################

#TORPID OVERNIGHT FAT MASS LOSS- SEASONAL SLOPES VS EVENING FAT CONTENT

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_point(aes(x=Fat_Eve_p, y=Fat_delta_mg, color=Season), alpha=.8, lwd=2)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_shape_manual(values = c(16,1,17,18,19))+
    geom_smooth(method="lm",aes(x=Fat_Eve_p, y=Fat_delta_mg, col=Season),se=F)+
  #scale_y_continuous(limits=c(0,10))+
  scale_y_continuous(name="Overnight Fat Mass Loss (mg)")+
  scale_x_continuous(name="Evening Fat Content (%)")+
  my_theme

lm_full<-lmer(Fat_delta_mg ~ -1+Season+Season:Fat_Eve_p+Season:Night_Duration+
                             (1+Fat_Eve_p|Bird_ID)  
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Summer","Fattening","Migration"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e8)))

shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, pairwise~Season, var="Fat_Eve_p")
et

et<-emtrends(lm_full, pairwise~Season, var="Night_Duration")
et

################################################################################

#TORPID OVERNIGHT FAT MASS LOSS- SEASONAL SLOPES VS TORPOR DURAITON
#raw data dont make for a  model with normal residuals. so i do a sqrt transformation below this that works

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_point(aes(x=Torpor_Duration_ET_h, y=Fat_delta_mg, color=Season,shape=Torpor_Use), alpha=.8, lwd=2)+
  geom_point(data=run.agg[run.agg$Torpor_Use=="NORMO"&run.agg$Season %in% c("Summer","Fattening","Migration"),],aes(x=Torpor_Duration_ET_h, y=Fat_delta_mg, color=Season,shape=Torpor_Use), alpha=.8, lwd=2)+
    scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_shape_manual(values = c(1,16,17,18,19))+
    geom_smooth(method="lm",aes(x=Torpor_Duration_ET_h, y=Fat_delta_mg, col=Season),se=F)+
  #scale_y_continuous(name="Overnight Fat Content Loss (%)",limits=c(0,.3))+
  scale_x_continuous(name="Torpor Duration (hrs)",limits=c(0,9))+
    my_theme

lm_full<-lmer((Fat_delta_mg) ~ -1+Season:Torpor_Duration_ET_h+Night_Duration+
                             (1|Bird_ID)
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Summer","Fattening","Migration"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full)) 

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, pairwise~Season, var="Torpor_Duration_ET_h")
et

################################################################################
#TORPID OVERNIGHT FAT MASS LOSS- SEASONAL SLOPES VS TORPOR DURAITON
#THIS IS THE SQRT TRANSFORMATION VERSION

#from https://stats.stackexchange.com/questions/11359/what-could-be-the-reason-for-using-square-root-transformation-on-data
#Square rooting Y also helps when you have the problem that the size of your residuals progressively increases as your values of X increase (i.e. the scatter of data points around the fitted line gets more marked as you move along it).

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_point(aes(x=Torpor_Duration_ET_h, y=sqrt(Fat_delta_mg), color=Season,shape=Torpor_Use), alpha=.8, lwd=2)+
  geom_point(data=run.agg[run.agg$Torpor_Use=="NORMO"&run.agg$Season %in% c("Summer","Fattening","Migration"),],aes(x=Torpor_Duration_ET_h, y=sqrt(Fat_delta_mg), color=Season,shape=Torpor_Use), alpha=.8, lwd=2)+

    scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_shape_manual(values = c(1,16,17,18,19))+
    geom_smooth(method="lm",aes(x=Torpor_Duration_ET_h, y=sqrt(Fat_delta_mg), col=Season),se=F)+
  #scale_y_continuous(name="Overnight Fat Content Loss (%)",limits=c(0,.3))+
  scale_x_continuous(name="Torpor Duration (hrs)",limits=c(0,9))+

    my_theme

lm_full<-lmer(sqrt(Fat_delta_mg) ~ -1+Season:Torpor_Duration_ET_h+Night_Duration+
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Summer","Fattening","Migration"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full)) 
hist(residuals(lm_full))
qqnorm(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, pairwise~Season, var="Torpor_Duration_ET_h")
et

plot(allEffects(lm_full))
plot(allEffects(lm_full, partial.residuals=T))

################################################################################
################################################################################

#NORMOTHERMIC OVERNIGHT FAT MASS LOSS-SEASONAL MEANS

ggplot(data=run.agg[run.agg$Torpor_Use=="NORMO"&run.agg$Run_ID!="B13_8.11.19"& run.agg$Season %in% c("Summer","Fattening","Migration"),])+
  geom_boxplot(aes(x=Season, y=Fat_delta_mg, color=Season), alpha=.2, lwd=1)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
  geom_point(aes(x=Season, y=Fat_delta_mg), col="black",alpha=.8, lwd=2)+
 scale_y_continuous(limits=c(0,25), name="Overnight Fat Content Loss (mg)")+
  my_theme

lm_full<-lmer(Fat_delta_mg ~ -1+Season+Night_Duration+
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Torpor_Use=="NORMO"&run.agg$Run_ID!="B13_8.11.19"&run.agg$Season %in% c("Summer","Fattening","Migration"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

em<-emmeans(lm_full, pairwise~Season)
em

################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################

#ANALYSES FOR NON FATTENERS

#NONFATTENER ANALYSIS
################################################################################

#BODY COMPOSITION

################################################################################

#BODY MASS- SEASONAL MEANS

ggplot(data=run.agg[run.agg$Season %in% c("Non-Fattener"),])+
  geom_boxplot(aes(x= Season ,y=Body_Morn_g, col=Season), lwd=1)+
  geom_point(aes(x= Season ,y=Body_Morn_g), col="black", lwd=2)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_y_continuous(limits = c(2.25,4.5),breaks = seq(0, 5, by = .5), name = "Morning Body Mass (g)")+
#  scale_x_continuous(limits = c(20,125),breaks = seq(0, 125, by = 30),name="Date")+
    #facet_wrap(~Bird_ID)+
  my_theme

lm_full<-lmer(Body_Morn_g ~
                              (1|Bird_ID) 
                            , data=run.agg[run.agg$Season %in% c("Non-Fattener"),], REML=F,
                            control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full) 
summary(lm_full)

em<-emmeans(lm_full, ~1)
em

################################################################################

#BODY MASS- SEASONAL SLOPES VS DATE

ggplot(data=run.agg[run.agg$Season %in% c("Non-Fattener"),])+
  geom_point(aes(x= Date_Index ,y=Body_Morn_g, col=Season), lwd=2, alpha=.6)+
  geom_smooth(method="lm",aes(x=Date_Index,y=Body_Morn_g, col=Season),se=F)+
  #geom_smooth(method="lm",aes(x=Date_Index,y=Body_Morn_g, linetype=Season),col="black",se=F, lwd=2)+
    scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_y_continuous(limits = c(2.25,4.5),breaks = seq(0, 5, by = .5), name = "Morning Body Mass (g)")+
    scale_x_continuous(limits = c(20,125),breaks = seq(0, 125, by = 10),name="Date")+
  facet_wrap(~Bird_ID)+
  my_theme

lm_full<-lmer(Body_Morn_g ~ Date_Index+
                              (1+Date_Index|Bird_ID)
                            , data=run.agg[run.agg$Season %in% c("Non-Fattener"),], REML=F,
                            control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full) 
summary(lm_full)

et<-emtrends(lm_full, ~1, var="Date_Index" )
et

################################################################################
################################################################################

#FAT_CONTENT- SEASONAL MEANS

ggplot(data=run.agg[run.agg$Season %in% c("Non-Fattener"),])+
  geom_boxplot(aes(x= Season ,y=Fat_Morn_p, col=Season), alpha=.4)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    geom_point(aes(x=Season,y=Fat_Morn_p),col="black")+
  my_theme

lm_full<-lmer(Fat_Morn_p ~ #Night_Duration+
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Season %in% c("Non-Fattener"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full)) 

AIC(lm_full)
summary(lm_full)

em<-emmeans(lm_full, ~1)
em

################################################################################

#FAT CONTENT- SEASONAL SLOPES VS DATE

ggplot(data=run.agg[run.agg$Season %in% c("Non-Fattener"),])+
  geom_point(aes(x= Date_Index ,y=Fat_Morn_p, col=Season), lwd=3, alpha=.4)+scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    geom_smooth(method="lm",aes(x=Date_Index,y=Fat_Morn_p, col=Season),se=F)+
  #facet_wrap(~Bird_ID)+
  my_theme

lm_full<-lmer(Fat_Morn_p ~ Date_Index+ 
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Season %in% c("Non-Fattener"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full)) 

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, ~1, var="Date_Index" ) 
et

################################################################################
################################################################################

#LEAN MASS- SEASONAL MEANS

ggplot(data=run.agg[run.agg$Lean_Quality=="GOOD" &run.agg$Season %in% c("Non-Fattener"),])+
  geom_boxplot(aes(x= Season ,y=Lean_Morn_g, col=Season), alpha=.4)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    geom_point(aes(x=Season,y=Lean_Morn_g),col="black")+
  my_theme

lm_full<-lmer(Lean_Morn_g ~ 
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Season %in% c("Non-Fattener") & run.agg$Lean_Quality=="GOOD"&is.na(run.agg$Lean_Morn_g)==F,], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

em<-emmeans(lm_full, ~1) 
em

################################################################################

#LEAN MASS- SEASONAL SLOPES VS DATE

ggplot(data=run.agg[run.agg$Season %in% c("Non-Fattener") &run.agg$Lean_Quality=="GOOD",])+
  geom_point(aes(x= Date_Index ,y=Lean_Morn_g, col=Season), lwd=3, alpha=.4)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    geom_smooth(method="lm",aes(x=Date_Index,y=Lean_Morn_g, col=Season),se=F)+
  #facet_wrap(~Bird_ID)+
  my_theme

lm_full<-lmer((Lean_Morn_g) ~ Date_Index+ 
                             (1|Bird_ID) #ADDING Date_Index MESSES UP THE BETWEEN SEASON COMPARISONS. AND THIS IS ACTUALLY A BETTER AIC
                            , data=run.agg[run.agg$Season %in% c("Non-Fattener") &run.agg$Lean_Quality=="GOOD",], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, ~1, var="Date_Index" ) 
et

################################################################################
################################################################################

#FOOD INTAKE- SEASONAL MEANS

food.data.week<-food.data %>%
  #group by run-specific variables that have one value per run. 
  group_by(Week, Bird_ID,  Season, Day_Length) %>%
  #summarize (usually mean +- std error) variables that have multiple values per run (i.e. minute data)
  summarize(Food_Intake = mean(Food_Intake, na.rm = TRUE),
            Food_Intake_se = std.error(Food_Intake, na.rm = TRUE))%>%
          data.frame()

ggplot(data=food.data.week[food.data.week$Season %in% c("Non-Fattener"),])+
  geom_point(aes(x= Season ,y=Food_Intake),col="black", lwd=3, alpha=.4)+
  geom_boxplot(aes(x= Season ,y=Food_Intake, col=Season), alpha=.4)+
  scale_color_manual(values=c("blue", "green","red","black", "blue"))+
      scale_y_continuous(name = "Daily Food Consumption (mL)")+
  scale_x_discrete(name="Period")+
  my_theme

lm_full<-lmer(sqrt(Food_Intake) ~ Day_Length+
                             (1|Bird_ID) 
                            , data=food.data.week[food.data.week$Season %in% c("Non-Fattener")&is.na(food.data.week$Food_Intake)==F&is.na(food.data.week$Day_Length)==F,,], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e8)))

shapiro.test(residuals(lm_full)) 

AIC(lm_full)
summary(lm_full)

em<-emmeans(lm_full, ~1)
em

#without the transformation
lm_full<-lmer((Food_Intake) ~ Day_Length+
                             (1|Bird_ID) 
                            , data=food.data.week[food.data.week$Season %in% c("Non-Fattener")&is.na(food.data.week$Food_Intake)==F&is.na(food.data.week$Day_Length)==F,,], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e8)))

shapiro.test(residuals(lm_full)) 

AIC(lm_full)
summary(lm_full)

em<-emmeans(lm_full, ~1)
em

################################################################################

#FOOD INTAKE- SEASONAL SLOPES VS DATE

ggplot(data=food.data.week[food.data.week$Season %in% c("Non-Fattener"),])+
  geom_point(aes(x= Week ,y=Food_Intake, col=Season), lwd=3, alpha=.4)+
  scale_color_manual(values=c("blue", "yellow","red","black"))+
    geom_smooth(method="lm",aes(x=Week,y=Food_Intake, col=Season),se=F)+
#      scale_y_continuous(name = "Daily Food Consumption (mL)", limits=c(0,35))+
  scale_x_continuous(name="Week since June 1", limits=c(0,18))+
  #facet_wrap(~Bird_ID)+
  my_theme

food.data.week
lm_full<-lmer(sqrt(Food_Intake) ~ Week+Day_Length+#
                             (1|Bird_ID)  #PUTTING WEEK IN MAKES SINGULAR and worse aic
                            , data=food.data.week[food.data.week$Season %in% c("Non-Fattener")&is.na(food.data.week$Day_Length)==F&is.na(food.data.week$Food_Intake)==F,], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full)) #do a sqrt transformation

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, ~1, var="Week" )
et

#without transformation
lm_full<-lmer((Food_Intake) ~ Week+Day_Length+#
                             (1|Bird_ID)  
                            , data=food.data.week[food.data.week$Season %in% c("Non-Fattener")&is.na(food.data.week$Day_Length)==F&is.na(food.data.week$Food_Intake)==F,], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full)) #normal

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, ~1, var="Week" )
et

et<-emtrends(lm_full, ~1, var="Day_Length" )
et

################################################################################
################################################################################

#FAT VS BODY MASS- REPEATED MEASURES CORRELATION 

ggplot(data=run.agg[run.agg$Season %in% c("Non-Fattener"),])+
      geom_smooth(method="lm",aes(x=Body_Morn_g,y=Fat_Morn_g,group=Bird_ID),col="grey", linetype="dashed",lwd=.5,se=F,alpha=.1)+
    geom_smooth(method="lm",aes(x=Body_Morn_g,y=Fat_Morn_g),se=F, col="black",lwd=1,alpha=.1)+
 geom_smooth(method="lm",aes(x=Body_Morn_g,y=Fat_Morn_g,col=Season),lwd=.5,se=F,alpha=.1)+
    geom_point(aes(x= Body_Morn_g ,y=Fat_Morn_g, col=Season), lwd=3, alpha=.4, shape="circle")+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
  scale_y_continuous(name = "Morning Fat Mass (g)")+
  scale_x_continuous(name="Morning Body Mass (g)")+
  my_theme+theme(legend.position="none")

body.fat <- rmcorr(Bird_ID, Body_Morn_g, (Fat_Morn_g)^2, dataset=run.agg[run.agg$Season %in% c("Non-Fattener"),], nreps = 100, bstrap.out = F)
body.fat.r<-round(as.numeric(body.fat[1]),digits=3)
body.fat.p<-round(as.numeric(body.fat[3]),3)
body.fat.slope<-round(as.numeric(last(body.fat$model$coefficients)),3)
body.fat.yint<-round(as.numeric(body.fat$model$coefficients[1]),3)

shapiro.test(body.fat$model$residuals) #doing a ^2 transformation makes this  normal

body.fat 
#summary(body.fat)
body.fat.r
body.fat.p 
body.fat.slope
body.fat.yint 

################################################################################
################################################################################

#LEAN VS BODY MASS- REPEATED MEASURES CORRELATION

ggplot(data=run.agg[run.agg$Season %in% c("Non-Fattener")&&run.agg$Lean_Quality=="GOOD"&is.na(run.agg$Lean_Morn_g)==F,])+
        geom_smooth(method="lm",aes(x=Body_Morn_g,y=Lean_Morn_g,group=Bird_ID),col="grey", linetype="dashed",lwd=.5,se=F,alpha=.1)+
    geom_smooth(method="lm",aes(x=Body_Morn_g,y=Lean_Morn_g),se=F, col="black",lwd=.5,alpha=.1)+
    #geom_smooth(method="lm",aes(x=Body_Morn_g,y=Lean_Morn_g,col=Season),lwd=.5,se=F,alpha=.1)+
  geom_point(aes(x= Body_Morn_g ,y=Lean_Morn_g, col=Season), lwd=3, alpha=.4, shape="circle")+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
  
  my_theme

body.lean <- rmcorr(Bird_ID, Body_Morn_g, Lean_Morn_g, dataset=run.agg[run.agg$Season %in% c("Non-Fattener")&run.agg$Lean_Quality=="GOOD"&is.na(run.agg$Lean_Morn_g)==F,])
body.lean.r<-round(as.numeric(body.lean[1]),digits=3)
body.lean.p<-round(as.numeric(body.lean[3]),3)
body.lean.slope<-round(as.numeric(last(body.lean$model$coefficients)),3)
body.lean.yint<-round(as.numeric(body.lean$model$coefficients[1]),3)

shapiro.test(body.lean$model$residuals)

body.lean
body.lean.r 
body.lean.p 
body.lean.slope 
body.lean.yint

################################################################################
#END BODY COMPOSITION MODELS
################################################################################
################################################################################

#FAT_CONTENT- SEASONAL MEANS

ggplot(data=run.agg[run.agg$Season %in% c("Non-Fattener"),])+
  geom_boxplot(aes(x= Season ,y=Fat_Eve_p, col=Season), alpha=.4)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    geom_point(aes(x=Season,y=Fat_Eve_p),col="black")+
  my_theme

lm_full<-lmer(Fat_Eve_p ~ Night_Duration+
                            (1|Bird_ID) 
                            , data=run.agg[run.agg$Season %in% c("Non-Fattener"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full)) 
leveneTest(residuals(lm_full) ~Season , data=run.agg[run.agg$Season %in% c("Non-Fattener"),])
plot(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

em<-emmeans(lm_full, ~1)
em

plot(allEffects(lm_full))
plot(allEffects(lm_full, partial.residuals=T))

################################################################################

#FAT CONTENT- SEASONAL SLOPES VS DATE

ggplot(data=run.agg[run.agg$Season %in% c("Non-Fattener"),])+
  geom_point(aes(x= Date_Index ,y=Fat_Eve_p, col=Season), lwd=3, alpha=.4)+scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    geom_smooth(method="lm",aes(x=Date_Index,y=Fat_Eve_p, col=Season),se=F)+
  #facet_wrap(~Bird_ID)+
  my_theme

lm_full<-lmer(Fat_Eve_p ~ Date_Index+ Night_Duration+
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Season %in% c("Non-Fattener"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full)) 
leveneTest(residuals(lm_full) ~Season , data=run.agg[run.agg$Season %in% c("Non-Fattener"),])
plot(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, ~1, var="Date_Index" ) #####SHIIIIIITTTTT
et

plot(allEffects(lm_full))
plot(allEffects(lm_full, partial.residuals=T))

################################################################################
################################################################################

#DRIVERS OF FATTENING PERIOD

################################################################################

#BODY MASS GAINS DURING FATTENING VS TORPOR DURATOIN

#best model is just torpor duration model model, but since food is 
#of explicit interest I still use the full model. 

ggplot(data=period.cutoffs)+
  geom_point(aes(x=Fattening_TorDur_mean,y=Body_gi_F))+
  geom_smooth(method="lm",aes(x=Fattening_TorDur_mean,y=Body_gi_F),se=T)+
      scale_y_continuous(name="Body Mass Gains During Fattening (g)")+
  scale_x_continuous(name="Mean Torpor Duration During Fattening (hrs)")+
  my_theme

ggplot(data=period.cutoffs)+
  geom_point(aes(x=Fattening_Food_mean,y=Body_gi_F))+
  geom_smooth(method="lm",aes(x=Fattening_Food_mean,y=Body_gi_F),se=T)+
      scale_y_continuous(name="Body Mass Gains During Fattening (g)")+
  scale_x_continuous(name="Daily Food Consumption During Fattening (mL)")+
  my_theme

lm_full<-lm(Body_gi_F~ Fattening_TorDur_mean+Fattening_Food_mean
           , data=period.cutoffs[is.na(period.cutoffs$Fattening_TorDur_mean)==F,])

shapiro.test(residuals(lm_full))

summary(lm_full)

################################################################################
################################################################################

#FATTENING DURATION GAINS DURING FATTENING VS TORPOR DURATOIN
ggplot(data=period.cutoffs)+
  geom_point(aes(x=Fattening_TorDur_mean,y=Fat_Duration))+
  geom_smooth(method="lm",aes(x=Fattening_TorDur_mean,y=Fat_Duration),se=T)+
     scale_y_continuous(name="Fattening Period Duration (days)")+
  scale_x_continuous(name="Mean Torpor Duration During Fattening (hrs)")+
  my_theme

#FATTENING DURATION GAINS DURING FATTENING VS MEAN FOOD INTAKE DURING Fattening 
ggplot(data=period.cutoffs)+
  geom_point(aes(x=Fattening_Food_mean,y=Fat_Duration))+
  geom_smooth(method="lm",aes(x=Fattening_Food_mean,y=Fat_Duration),se=T)+
    scale_y_continuous(name="Fattening Period Duration (days)")+
  scale_x_continuous(name="Mean Food Consumption During Fattening (mL)")+
  my_theme

lm_full<-lm(Fat_Duration~Fattening_TorDur_mean+Fattening_Food_mean 
           , data=period.cutoffs[is.na(period.cutoffs$Fattening_TorDur_mean)==F,])

shapiro.test(residuals(lm_full))

summary(lm_full)

################################################################################
#END FATTENING PERIOD MODELS
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################

#TORPOR USE

################################################################################

#TORPOR PROPESITY- SEASONAL MEANS

ggplot(data=prop[prop$Season %in% c("Non-Fattener"),])+
  geom_boxplot(aes(x=Season, y=Torpor_Propensity, col=Season))+
  geom_point(aes(x=Season, y=Torpor_Propensity))+
  my_theme
# 
#Dont actually need to do lmer for this becuase its not actually repeated measures. 
mean(prop$Torpor_Propensity[prop$Season=="Non-Fattener"],na.rm=T)
#48.6
std.error(prop$Torpor_Propensity[prop$Season=="Non-Fattener"],na.rm=T)
#10.1
# lm_full<-lmer(Torpor_Propensity ~ 
#                              (1|Bird_ID) 
#                             , data=prop[prop$Season %in% c("Non-Fattener"),], REML=F,
#               control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))
# 
# shapiro.test(residuals(lm_full))
# 
# AIC(lm_full)
# summary(lm_full)
# 
# em<-emmeans(lm_full, ~1)
# em

################################################################################
################################################################################

#PROBABILITY OF TORPOR USE- LOGISTIC REGRESSION- SEASONAL SLOPES

ggplot(data=run.agg[run.agg$Season %in% c("Non-Fattener"),])+ 
  geom_point(aes(x=Fat_Eve_p, y=Torpor_Use_bin, color=Season), alpha=.4, lwd=3)+scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_shape_manual(values = c(16,1,17,18,19))+
    geom_smooth(method="glm",aes(x=Fat_Eve_p, y=Torpor_Use_bin, color=Season),method.args=list(family="binomial"),se=F,fullrange=T)+
      scale_y_continuous(name = "Probability of Torpor Use")+
  scale_x_continuous(name="Eveing Fat Content (%)")+
  #scale_x_continuous(limits=c(2,5))+
  my_theme

lm_full<-glmer(Torpor_Use_bin ~Fat_Eve_p+
                             (1|Bird_ID) #
                            , data=run.agg[run.agg$Season %in% c("Non-Fattener"),],family = "binomial",
                                           control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full) 
summary(lm_full)

et<-emtrends(lm_full, ~1, var="Fat_Eve_p")
et

#night duration doesnt let model run properly.

######################################################

#seeing if i can just do a separate model for night length's effect on torpor propensity

ggplot(data=run.agg[run.agg$Season %in% c("Non-Fattener"),])+ 
  geom_point(aes(x=Night_Duration, y=Torpor_Use_bin, color=Season), alpha=.4, lwd=3)+scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_shape_manual(values = c(16,1,17,18,19))+
    geom_smooth(method="glm",aes(x=Night_Duration, y=Torpor_Use_bin, color=Season),method.args=list(family="binomial"),se=F,fullrange=T)+
      scale_y_continuous(name = "Probability of Torpor Use")+
  scale_x_continuous(name="Night Length (Hours)")+
  #scale_x_continuous(limits=c(2,5))+
  my_theme

lm_full<-glmer((Torpor_Use_bin) ~-1+Night_Duration+
                             (1|Bird_ID) #
                            , data=run.agg[run.agg$Season %in% c("Non-Fattener"),],family = "binomial",
                                           control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e8)))

#its not normal but it does converge, and i dont think normality is an assumption for this anyway!

AIC(lm_full) 
summary(lm_full)

et<-emtrends(lm_full, ~1, var="Night_Duration")
et


################################################################################
################################################################################

#TORPOR DURATION- SEASONAL MEANS- USING DURATION AS HOURS

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"& run.agg$Season %in% c("Non-Fattener"),])+
  geom_boxplot(aes(x=Season, y=Torpor_Duration_ET_h, color=Season), alpha=.2, lwd=1)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
  geom_point(aes(x=Season, y=Torpor_Duration_ET_h), col="black",alpha=.8, lwd=2)+
      scale_y_continuous(name = "Torpor Duration (hrs)",limits=c(0,10))+
  my_theme

lm_full<-lmer(Torpor_Duration_ET_h ~ Night_Duration+
                             (1|Bird_ID) 
                            ,data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Non-Fattener"),], REML = F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

em<-emmeans(lm_full, ~1)
em

################################################################################

#TORPOR DURATION- SEASONAL SLOPES VS FAT- USING DURATION AS HOURS

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"& run.agg$Season %in% c("Non-Fattener"),])+
  geom_point(aes(x=Fat_Eve_p, y=Torpor_Duration_ET_h, color=Season), alpha=.4, lwd=2)+
    scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_shape_manual(values = c(16,1,17,18,19))+
  geom_smooth(method="lm",aes(x=Fat_Eve_p, y=Torpor_Duration_ET_h, col=Season),se=F)+
        scale_y_continuous(name = "Torpor Duration (hrs)",limits=c(0,10))+
      scale_x_continuous(name="Evening Fat Content (%)")+
  my_theme

run.agg$Night_Duration

lm_full<-lmer(Torpor_Duration_ET_h ~ Fat_Eve_p+Night_Duration+ 
                             (1+Fat_Eve_p|Bird_ID) 
                            ,data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Non-Fattener"),], REML = F,
                            control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, ~1, var="Fat_Eve_p")
et

et<-emtrends(lm_full, ~1, var="Night_Duration")
et

plot(allEffects(lm_full, partial.residuals=T))

################################################################################
################################################################################

#PRETORPOR ENERGY EXPENDITURE- SEASONAL MEANS

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"& run.agg$Season %in% c("Non-Fattener"),])+
  geom_boxplot(aes(x=Season, y=Fat_Loss_pretorpor_kJ, color=Season), alpha=.2, lwd=1)+scale_color_manual(values=c("blue", "green","red","black", "grey"))+
  geom_point(aes(x=Season, y=Fat_Loss_pretorpor_kJ), col="black",alpha=.8, lwd=2)+
 #scale_y_continuous(limits=c(0,7), name="Pretorpor Fat Expenditure (kJ)")+
  my_theme

lm_full<-lmer(Fat_Loss_pretorpor_kJ ~ Night_Duration+
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Non-Fattener"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full)) 
AIC(lm_full)
summary(lm_full)

em<-emmeans(lm_full, ~1)
em

################################################################################

#PRETORPOR ENERGY EXPENDITURE- SEASONAL SLOPES VS FAT

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Non-Fattener"),])+
  geom_point(aes(x=Fat_Eve_p, y=Fat_Loss_pretorpor_kJ, color=Season), alpha=.8, lwd=2)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_shape_manual(values = c(16,1,17,18,19))+
    geom_smooth(method="lm",aes(x=Fat_Eve_p, y=Fat_Loss_pretorpor_kJ, col=Season),se=F)+
  #scale_y_continuous(limits=c(0,10))+
  scale_y_continuous(name="Pretorpor Fat Expenditure (kJ)")+
  my_theme

lm_full<-lmer(Fat_Loss_pretorpor_kJ ~ Fat_Eve_p+Night_Duration+
                             (1+Fat_Eve_p|Bird_ID) 
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Non-Fattener"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, ~1, var="Fat_Eve_p")
et

et<-emtrends(lm_full, ~1, var="Night_Duration")
et

################################################################################
################################################################################

#TORPOR ENTRY TIME- SEASONAL MEANS

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"& run.agg$Season %in% c("Non-Fattener"),])+
  geom_boxplot(aes(x=Season, y=Crit_Time_h, color=Season), alpha=.2, lwd=1)+scale_color_manual(values=c("blue", "green","red","black", "grey"))+
  geom_point(aes(x=Season, y=Crit_Time_h), col="black",alpha=.8, lwd=2)+
  scale_y_continuous(limits=c(0,10), name="Time of Entry (minute of night)")+
  my_theme

lm_full<-lmer(Crit_Time_h~ Night_Duration+
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Non-Fattener"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))   

AIC(lm_full)
summary(lm_full)

em<-emmeans(lm_full, ~1)
em

################################################################################

#TORPOR ENTRY TIME- SLOPES VS FAT

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"& run.agg$Season %in% c("Non-Fattener"),])+
  geom_point(aes(x=Fat_Eve_p, y=Crit_Time_h, color=Season), alpha=.8, lwd=2)+scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_shape_manual(values = c(16,1,17,18,19))+
    geom_smooth(method="lm",aes(x=Fat_Eve_p, y=Crit_Time_h, col=Season),se=F)+
  #scale_y_continuous(limits=c(0,10))+
  my_theme

lm_full<-lmer(Crit_Time_h ~ Fat_Eve_p+Night_Duration+
                             (1+Fat_Eve_p|Bird_ID) 
                , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Non-Fattener"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))


shapiro.test(residuals(lm_full)) 

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, ~1, var="Fat_Eve_p")
et

et<-emtrends(lm_full, ~1, var="Night_Duration")
et

################################################################################
################################################################################

#TORPOR ENTRY FAT LEVELS - SEASONAL MEANS

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"& run.agg$Season %in% c("Non-Fattener"),])+
  geom_boxplot(aes(x=Season, y=Crit_Fat_p, color=Season), alpha=.2, lwd=1)+scale_color_manual(values=c("blue", "green","red","black", "grey"))+
  geom_point(aes(x=Season, y=Crit_Fat_p), col="black",alpha=.8, lwd=2)+
 scale_y_continuous(limits=c(0,45), name="Fat % at Torpor Entry")+
  my_theme

lm_full<-lmer(Crit_Fat_p ~ 
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Non-Fattener"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full) 
summary(lm_full)

em<-emmeans(lm_full, ~1)
em

#NIGHT LENGTH DOES NOT IMPROVE AIC

################################################################################

#TORPOR ENTRY FAT LEVELS - SEASONAL MEANS- ABSOLUTES
run.agg$Crit_Fat_g<-run.agg$Crit_Fat_p*.01*run.agg$Body_Morn_g

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"& run.agg$Season %in% c("Non-Fattener"),])+
  geom_boxplot(aes(x=Season, y=Crit_Fat_g, color=Season), alpha=.2, lwd=1)+scale_color_manual(values=c("blue", "green","red","black", "grey"))+
  geom_point(aes(x=Season, y=Crit_Fat_g), col="black",alpha=.8, lwd=2)+
 scale_y_continuous(limits=c(0,1), name="Fat Mass (g) at Torpor Entry")+
  my_theme

lm_full<-lmer(Crit_Fat_g*100 ~ 
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Non-Fattener"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

emm_options(opt.digits = FALSE)

em<-emmeans(lm_full, ~1)
em

#NIGHT LENGTH DOES NOT IMPROVE AIC

################################################################################
###############################################################################

#TORPOR ENTRY FAT LEVELS- SEASONAL SLOPES VS TIME OF ENTRY

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Non-Fattener"),])+
  geom_point(aes(x=Crit_Time_min, y=Crit_Fat_p, color=Season), alpha=.4, lwd=2)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_shape_manual(values = c(16,1,17,18,19))+
  geom_smooth(method="lm",aes(x=Crit_Time_h, y=Crit_Fat_p, col=Season),se=F)+
  #scale_y_continuous(limits=c(0,10))+
  scale_y_continuous(name="Fat Content (%) at Torpor Entry")+  
  scale_x_continuous(name="Time of Night at Entry (min)")+
  my_theme

lm_full<-lmer(Crit_Fat_p ~ Crit_Time_h+Night_Duration+  
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Non-Fattener"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, ~1, var="Crit_Time_h")
et

et<-emtrends(lm_full, ~1, var="Night_Duration")
et

################################################################################

#TORPOR ENTRY FAT LEVELS- SEASONAL SLOPES VS DATE_INDEX
ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Non-Fattener"),])+
  geom_point(aes(x=Date_Index, y=Crit_Fat_p, color=Season), alpha=.8, lwd=2)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_shape_manual(values = c(16,1,17,18,19))+
    geom_smooth(method="lm",aes(x=Date_Index, y=Crit_Fat_p, col=Season),se=F)+
  #scale_y_continuous(limits=c(0,10))+
  scale_y_continuous(name="Fat% at Torpor Entry")+
  my_theme

lm_full<-lmer(Crit_Fat_p ~ Date_Index+#Night_Duration+
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Non-Fattener"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))
  
shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, ~1, var="Date_Index")
et

#night duration does not improve aic

################################################################################
################################################################################

#TORPID OVERNIGHT FAT MASS LOSS-SEASONAL MEANS

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Run_ID!="B13_8.11.19"& run.agg$Season %in% c("Non-Fattener"),])+
  geom_boxplot(aes(x=Season, y=Fat_delta_mg, color=Season), alpha=.2, lwd=1)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
  geom_point(aes(x=Season, y=Fat_delta_mg), col="black",alpha=.8, lwd=2)+
 scale_y_continuous(limits=c(0,25), name="Overnight Fat Content Loss (%)")+
  my_theme

lm_full<-lmer(Fat_delta_mg ~ Night_Duration+
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Run_ID!="B13_8.11.19"&run.agg$Season %in% c("Non-Fattener"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

em<-emmeans(lm_full, ~1)
em

################################################################################

#TORPID OVERNIGHT FAT MASS LOSS- SEASONAL SLOPES VS EVENING FAT CONTENT

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Non-Fattener"),])+
  geom_point(aes(x=Fat_Eve_p, y=Fat_delta_mg, color=Season), alpha=.8, lwd=2)+
  scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_shape_manual(values = c(16,1,17,18,19))+
    geom_smooth(method="lm",aes(x=Fat_Eve_p, y=Fat_delta_mg, col=Season),se=F)+
  #scale_y_continuous(limits=c(0,10))+
  scale_y_continuous(name="Overnight Fat Mass Loss (mg)")+
  scale_x_continuous(name="Evening Fat Content (%)")+
  my_theme

lm_full<-lmer(Fat_delta_mg ~ Fat_Eve_p+Night_Duration+
                             (1+Fat_Eve_p|Bird_ID)  
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Non-Fattener"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e8)))

shapiro.test(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, ~1, var="Fat_Eve_p")
et

et<-emtrends(lm_full, ~1, var="Night_Duration")
et

################################################################################

#TORPID OVERNIGHT FAT MASS LOSS- SEASONAL SLOPES VS TORPOR DURAITON
#raw data dont make for a  model with normal residuals. so i do a sqrt transformation below this that works

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Non-Fattener"),])+
  geom_point(aes(x=Torpor_Duration_ET_h, y=Fat_delta_mg, color=Season,shape=Torpor_Use), alpha=.8, lwd=2)+
  geom_point(data=run.agg[run.agg$Torpor_Use=="NORMO"&run.agg$Season %in% c("Non-Fattener"),],aes(x=Torpor_Duration_ET_h, y=Fat_delta_mg, color=Season,shape=Torpor_Use), alpha=.8, lwd=2)+
    scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_shape_manual(values = c(1,16,17,18,19))+
    geom_smooth(method="lm",aes(x=Torpor_Duration_ET_h, y=Fat_delta_mg, col=Season),se=F)+
  #scale_y_continuous(name="Overnight Fat Content Loss (%)",limits=c(0,.3))+
  scale_x_continuous(name="Torpor Duration (hrs)",limits=c(0,9))+
    my_theme

lm_full<-lmer((Fat_delta_mg) ~ -1+Torpor_Duration_ET_h+Night_Duration+
                             (1|Bird_ID)
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Non-Fattener"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full)) 
hist(residuals(lm_full))
qqnorm(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, pairwise~Season, var="Torpor_Duration_ET_h")
et

################################################################################
#TORPID OVERNIGHT FAT MASS LOSS- SEASONAL SLOPES VS TORPOR DURAITON
#THIS IS THE SQRT TRANSFORMATION VERSION

#from https://stats.stackexchange.com/questions/11359/what-could-be-the-reason-for-using-square-root-transformation-on-data
#Square rooting Y also helps when you have the problem that the size of your residuals progressively increases as your values of X increase (i.e. the scatter of data points around the fitted line gets more marked as you move along it).

ggplot(data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Non-Fattener"),])+
  geom_point(aes(x=Torpor_Duration_ET_h, y=sqrt(Fat_delta_mg), color=Season,shape=Torpor_Use), alpha=.8, lwd=2)+
  geom_point(data=run.agg[run.agg$Torpor_Use=="NORMO"&run.agg$Season %in% c("Non-Fattener"),],aes(x=Torpor_Duration_ET_h, y=sqrt(Fat_delta_mg), color=Season,shape=Torpor_Use), alpha=.8, lwd=2)+

    scale_color_manual(values=c("blue", "green","red","black", "grey"))+
    scale_shape_manual(values = c(1,16,17,18,19))+
    geom_smooth(method="lm",aes(x=Torpor_Duration_ET_h, y=sqrt(Fat_delta_mg), col=Season),se=F)+
  #scale_y_continuous(name="Overnight Fat Content Loss (%)",limits=c(0,.3))+
  scale_x_continuous(name="Torpor Duration (hrs)",limits=c(0,9))+

    my_theme

lm_full<-lmer(sqrt(Fat_delta_mg) ~ -1+Torpor_Duration_ET_h+Night_Duration+
                             (1|Bird_ID) 
                            , data=run.agg[run.agg$Torpor_Use=="TORPOR"&run.agg$Season %in% c("Non-Fattener"),], REML=F,
              control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))

shapiro.test(residuals(lm_full)) 
hist(residuals(lm_full))
qqnorm(residuals(lm_full))

AIC(lm_full)
summary(lm_full)

et<-emtrends(lm_full, ~1, var="Torpor_Duration_ET_h")
et

################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#