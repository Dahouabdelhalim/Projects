#*******************************************************************************
# Cesar D. Jimenez-Rodriguez
# Luxembourg Institute of Science and Technology (LIST)
# Environmental Research and Innovation Department (ERIN)
# Environmental Sensing and Modelling Unit
# Agro-Environmental Systems Group
# E-mail: cesar.jimenez@list.lu 
#*******************************************************************************

#-Script Description------------------------------------------------------------
# The following script plots the vulnerability curve following a sigmoidal function
# applied within CLM 5.0 (Kennedy et al., 2019; UCAR, 2020).
# [doi: https://doi.org/10.1029/2018MS001500] [URL: https://escomp.github.io/ctsm-docs/versions/release-clm5.0/html/tech_note/index.html]
#
# NOTE: plot_vulcurve_v1:202108#

#-Required Packages---------------------------------------------------------------------------------
library(dplyr)
library(lubridate)
library(tidyverse)
library(rdwd)
library(plyr)


#-User settings-----------------------------------------------------------------
rm(list = ls())

#-User settings-----------------------------------------------------------------
# Define absolute path of input and output files
res_path  = "~/Documents/CAPACITY/analysis/1_paper"
par_path = '~/Documents/CAPACITY/parameters'
#-Select ID of the SapFluxNet site --------------------------------------------#

site_id = 'FRA_PUE' # Site code from SapFluxNet.
stid <- 'FR-Pue'    # Site code from Fluxnet.
pftn=6              # Plant functional type from the CLM list.
yrk <- c(2001:2011) # This is the range of years where the analysis is focused on.
kmax <- 2*10^(-8)   # Maximum conductivity defined for the model.
expr <- c("std","brknn","brk91") # List of experiments to be evaluated according to the individual project code asisgned by the user.

#-Data Retrieval----------------------------------------------------------------
wd <- paste(res_path,"/",site_id,sep="")

setwd(wd)

sap <- read.csv(paste(res_path,"/",site_id,"/","sap_",site_id,".csv",sep = ""))
sap$date <- sap$time
sap$doy <- as.numeric(strftime(strptime(substr(sap$date,6,10),format = "%m-%d"), format = "%j"))
sap$time <- paste(substr(sap$date,0,4),"-",sap$doy,sep="");sap[c("X","doy")]<-NULL

s <- list.files(pattern="*.csv$")
s <- s[lapply(s,function(x) length(grep("sap",x,value=FALSE))) == 0]

df_input_list <- lapply(s, fread)
names(df_input_list) <- gsub(s, pattern=paste(site_id,"_",sep=""), replacement="")

df <- bind_rows(df_input_list, .id = "id")
df$id <- gsub(df$id, pattern=".csv", replacement="")
df$doy <- df$doy+1
df$time <- paste(df$yr,"-",df$doy,sep="")
df <- merge(sap,df,by="time",all=T)
df$yr <- as.integer(substr(df$time,0,4))

df <- df[df$yr %in% yrk,]
df$stand[is.na(df$stand)] <- 0
df <- df[!(format(strptime(df$date,format = "%Y-%m-%d"),"%m") == "02" & format(strptime(df$date,format = "%Y-%m-%d"), "%d") == "29"), , drop = FALSE] # With this line we remove the leap day of leap year

df$id <- factor(df$id, levels = c("std","brknn","brk91"))
df$PC_kleaf <- df$kleaf/kmax
df$PC_kxyl <- df$kxyl/kmax

df$id <- str_replace_all(df$id,c("std" = "DMC", "brknn" = "DBC", "brk91" = "FBC"))

df$month <- month(df$date)
df <- df[between(df$month,7,9),]

pdf(paste(res_path,"/",site_id,"/",stid,"_",expr,"_vul_cur.pdf",sep=""),width = 12,height = 12)
layout(matrix(c(1:18),3,6, byrow = T), widths=c(0.8,0.2,0.8,0.2,0.8,0.2), heights=c(1))
for (i in unique(df$id)) {
  x <- df[df$id==i,]
  for (j in c(7,8,9)) {
    par(mar=c(3.25,3.25,0.25,0),xpd=T,font.axis = 1) #(DLUR)
    plot(x$root[x$month==j],100*x$PC_kxyl[x$month==j],xlim=c(-10,0),pch=19,col=rgb(0.5,0.5,0.5,0.01),cex.lab=2,cex.axis=2,cex=3,ylim=c(0,100),xlab="\\n",ylab="\\n") #ylab="PLC [ % ]",xlab=expression(italic(psi)["stem"]*" [MPa]"))
    points(x$xyl[x$month==j],100*x$PC_kleaf[x$month==j],pch=15,col=rgb(0.13,0.67,0.13,0.01),cex=1.5)
    legend("topleft",legend = c("Leaves [L]","Xylem [X]","Frequency",5,25,50,">100"),bty="n",cex=1.75,pch=c(16,16,NA,16,16,16,16),col=c("forestgreen","grey",NA,rgb(0.5,0.5,0.5,0.05),rgb(0.5,0.5,0.5,0.25),rgb(0.5,0.5,0.5,0.5),rgb(0.5,0.5,0.5,1)))
    legend("bottomleft",legend = c(stid,i),bty="n",cex=1.75)
    legend("bottomright",legend = ifelse(j==7,"July",ifelse(j==8,"August","September")),bty="n",cex=1.75)    
    par(mar=c(3.25,0,0.25,0.25),xpd=T,font.axis = 1) #(DLUR)
    boxplot(x$PC_kxyl[x$month==j]*100,x$PC_kleaf[x$month==j]*100,ylim=c(0,100),border = c("grey50","forestgreen"),col="grey90",lwd=2,names = c("X","L"),yaxt="n",cex.lab=2,cex.axis=2,cex=2)
    }
}
dev.off()
